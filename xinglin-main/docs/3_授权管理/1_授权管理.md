# D_授权管理

## D.1 授权机制

### D.1.1 机器码生成
D.1.1.1 生成方式：软件首次运行时，读取硬件信息生成唯一机器码（经哈希处理）。
D.1.1.2 绑定策略：机器码与医院信息绑定，确保授权的唯一性。

### D.1.2 激活流程
D.1.2.1 激活请求：用户输入激活码后，WPF 将机器码 + 激活码发送至主控服务。
D.1.2.2 验证处理：主控服务验证激活码有效性，绑定机器码，并返回初始配置。
D.1.2.3 配置返回：返回内容包括模板版本、权限、过期时间等信息。

## D.2 心跳与校验

### D.2.1 心跳机制
D.2.1.1 发送频率：每次 WPF 启动时，自动向主控服务发送心跳包。
D.2.1.2 心跳内容：包含机器码、当前模板版本等信息。

### D.2.2 校验流程
D.2.2.1 状态检查：主控服务检查是否过期、是否被禁用、模板是否需强制更新。
D.2.2.2 异常处理：若授权失效，WPF 锁定核心功能（仅保留查看历史报告）。

## D.3 模板管理

### D.3.1 版本控制
D.3.1.1 集中管理：所有模板由主控服务集中管理，按版本号发布。
D.3.1.2 医院分配：支持为不同医院分配不同模板。

### D.3.2 更新策略
D.3.2.1 强制更新：可设置模板为"强制更新"，客户端版本低于服务端时无法使用。
D.3.2.2 自动更新：客户端启动时检测模板版本，自动下载更新。

## D.4 权限控制

### D.4.1 权限下发
D.4.1.1 格式定义：权限以 JSON 形式下发（如 `{"Print":true, "ExportPDF":false}`）。
D.4.1.2 动态控制：WPF 根据权限动态显示或隐藏功能按钮，实现精细化控制。

### D.4.2 权限管理
D.4.2.1 权限级别：支持不同级别的权限设置，如管理员、医生、护士等。
D.4.2.2 权限审计：所有权限变更均记录日志，便于追溯。