# 开发文档

## 1. 系统概述

“杏林”病理检验报告系统是一个面向医院检验科的本地化报告录入与打印工具，采用模块化设计，支持多源数据接入、动态模板生成和微信查询等功能。

## 2. 技术架构

### 2.1 核心技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| .NET | 8.0 | 核心框架 |
| WPF | 8.0 | 桌面端应用 |
| ASP.NET Core | 8.0 | 服务端应用 |
| Newtonsoft.Json | 13.0.4 | JSON序列化与反序列化 |
| PdfSharpCore | 1.3.67 | PDF生成 |
| Autofac | 8.0.0 | 依赖注入 |
| xunit | 2.5.3 | 单元测试 |
| Swashbuckle.AspNetCore | 6.6.2 | Swagger API文档 |

### 2.2 模块结构

```
xinglin-main/
├── 0_共享库/
│   ├── Xinglin.Common/         # 公共组件
│   ├── Xinglin.Core/           # 核心业务逻辑
│   ├── Xinglin.DataAdapters/   # 数据适配器
│   ├── Xinglin.Infrastructure/ # 基础设施
│   └── Xinglin.Security/       # 安全模块
├── 1_桌面端/
│   ├── Xinglin.Client.Core/    # 客户端核心
│   ├── Xinglin.Client.WPF/     # 客户端WPF应用
│   ├── Xinglin.Printing.Service/ # 打印服务
│   └── Xinglin.ReportTemplateEditor.WPF/ # 模板编辑器
├── 2_内网服务端/
│   └── Xinglin.Server.Internal/ # 内网服务端
├── 3_外网服务端/
│   └── Xinglin.Server.External/ # 外网服务端
├── 4_总控端/
│   └── Xinglin.Server.Master/  # 总控端
├── 5_数据库/
│   └── Xinglin.Database/       # 数据库脚本
├── 6_工具集/
│   └── Xinglin.Tools/          # 开发工具
├── 7_部署包/
│   └── Xinglin.Deployment/     # 部署脚本
├── 8_第三方库/
│   └── ThirdPartyLibs/         # 第三方库
└── 9_测试/
    ├── Xinglin.Core.Tests/     # 核心模块测试
    ├── Xinglin.Client.Tests/   # 客户端测试
    ├── Xinglin.ModularTests/   # 模块集成测试
    ├── Xinglin.Server.Internal.Tests/ # 内网服务端测试
    ├── Xinglin.Server.External.Tests/ # 外网服务端测试
    └── Xinglin.Server.Master.Tests/ # 总控端测试
```

## 3. 开发环境配置

### 3.1 安装开发工具

1. 安装Visual Studio 2022或更高版本
2. 安装.NET 8.0 SDK
3. 安装Git
4. 安装SQL Server或其他数据库（根据需要）

### 3.2 配置开发环境

1. 克隆代码仓库
2. 打开解决方案文件（.sln）
3. 还原NuGet包
4. 配置数据库连接字符串
5. 构建解决方案

### 3.3 运行项目

1. 设置启动项目
2. 启动调试
3. 访问应用

## 4. 编码规范

### 4.1 命名规范

- **命名空间**：使用PascalCase，如`Xinglin.Core.Elements`
- **类名**：使用PascalCase，如`ElementBase`
- **方法名**：使用PascalCase，如`ValidateBounds`
- **属性名**：使用PascalCase，如`Width`
- **字段名**：使用camelCase，如`_width`
- **参数名**：使用camelCase，如`canvasWidth`

### 4.2 代码风格

- 使用4个空格缩进
- 每行不超过120个字符
- 方法之间空一行
- 类之间空两行
- 合理使用注释

### 4.3 设计模式

- 采用MVVM设计模式（WPF应用）
- 采用依赖注入
- 采用命令模式
- 采用工厂模式

### 4.4 错误处理

- 使用自定义异常类
- 记录详细的错误日志
- 提供友好的错误信息
- 实现全局异常处理

## 5. 开发流程

### 5.1 分支管理

- **main**：主分支，用于发布稳定版本
- **develop**：开发分支，用于集成各功能分支
- **feature/**：功能分支，用于开发新功能
- **hotfix/**：热修复分支，用于修复生产环境中的紧急问题

### 5.2 代码提交规范

- 提交信息应清晰明了
- 每次提交只包含一个功能或修复
- 使用英文提交信息
- 提交信息格式：`[模块名] 功能描述`，如`[Core] 修复元素验证逻辑`

### 5.3 代码审查

- 所有代码必须经过代码审查
- 至少需要一名其他开发人员批准
- 审查内容包括代码质量、安全性、性能等

### 5.4 测试流程

1. 编写单元测试
2. 运行单元测试
3. 编写集成测试
4. 运行集成测试
5. 进行系统测试
6. 进行性能测试

## 6. 核心模块开发

### 6.1 Xinglin.Core模块

Xinglin.Core是系统的核心业务逻辑模块，包含以下主要组件：

- **元素模型**：所有模板元素的基类和派生类
- **模板定义**：报告模板的完整定义
- **服务接口**：各种服务的抽象接口

### 6.2 Xinglin.Infrastructure模块

Xinglin.Infrastructure是系统的基础设施模块，包含以下主要组件：

- **依赖注入**：依赖注入容器构建器
- **日志服务**：日志记录器
- **模板序列化**：JSON模板序列化实现
- **PDF渲染**：PDF渲染实现

### 6.3 Xinglin.DataAdapters模块

Xinglin.DataAdapters是系统的数据访问模块，包含以下主要组件：

- **数据适配器**：不同数据源的适配器实现
- **数据转换器**：不同数据格式之间的转换
- **数据源管理器**：数据源配置和管理

### 6.4 Xinglin.Security模块

Xinglin.Security是系统的安全模块，包含以下主要组件：

- **身份认证**：用户认证、令牌生成和验证
- **授权管理**：基于角色的访问控制
- **加密解密**：数据加密、解密和哈希计算

## 7. 服务端开发

### 7.1 内网服务端

内网服务端负责模板管理和报表生成，提供以下API：

- **模板管理API**：模板的增删改查、版本管理
- **报表生成API**：基于模板的报表生成、PDF导出
- **健康检查API**：服务健康状态检查

### 7.2 外网服务端

外网服务端负责远程模板访问和数据同步，提供以下API：

- **远程模板访问API**：远程模板的查询、下载
- **数据同步API**：模板数据的同步、更新
- **授权验证API**：服务访问的授权验证

### 7.3 总控端

总控端负责系统管理和权限管理，提供以下API：

- **系统管理API**：系统配置、模块管理
- **权限管理API**：用户、角色、权限管理
- **日志管理API**：系统日志的查询、分析

## 8. 桌面端开发

### 8.1 模板编辑器

模板编辑器是一个基于WPF的桌面应用，包含以下主要功能：

- **模板设计**：可视化模板设计界面
- **元素编辑**：支持多种元素的添加、修改、删除
- **属性面板**：元素属性的编辑和调整
- **模板树**：模板元素的层次结构显示
- **预览功能**：实时预览模板效果
- **设置界面**：应用设置管理

### 8.2 客户端应用

客户端应用是一个基于WPF的桌面应用，包含以下主要功能：

- **报告生成**：基于模板的报告生成
- **报告查询**：报告的查询、查看、打印
- **数据源管理**：数据源的配置和管理
- **模板管理**：模板的导入、导出、更新

## 9. 测试指南

### 9.1 单元测试

- 使用xunit框架编写单元测试
- 测试覆盖率不低于80%
- 测试重点包括核心业务逻辑、数据验证、异常处理等

### 9.2 集成测试

- 测试模块之间的集成
- 测试API接口
- 测试数据访问

### 9.3 系统测试

- 测试整个系统的功能
- 测试系统的性能
- 测试系统的安全性

### 9.4 性能测试

- 测试系统的响应时间
- 测试系统的并发处理能力
- 测试系统的资源占用情况

## 10. 部署指南

### 10.1 单机部署

- 适用于小型医院或诊所
- 所有组件部署在同一台服务器上
- 数据存储在本地数据库

### 10.2 分布式部署

- 适用于大型医院或医疗集团
- 内网服务端部署在医院内部网络
- 外网服务端部署在云端
- 总控端部署在云端或总部服务器
- 数据存储在分布式数据库

### 10.3 部署步骤

1. 配置服务器环境
2. 安装依赖软件
3. 部署应用程序
4. 配置数据库
5. 配置网络
6. 启动服务
7. 验证服务

## 11. 监控与维护

### 11.1 系统监控

- 监控服务健康状态
- 监控系统性能指标
- 监控系统错误日志

### 11.2 日志管理

- 记录详细的系统日志
- 支持日志级别配置
- 支持日志查询和分析
- 定期清理过期日志

### 11.3 备份策略

- 定期备份数据库
- 定期备份模板文件
- 定期备份配置文件
- 测试备份恢复流程

## 12. 安全性开发

### 12.1 身份认证

- 基于JWT的身份认证
- 支持刷新令牌机制
- 支持API密钥验证

### 12.2 授权管理

- 基于角色的访问控制
- 细粒度的权限管理
- 支持动态权限分配

### 12.3 数据加密

- 敏感数据传输加密
- 密码哈希存储
- 数据库连接加密

### 12.4 安全审计

- 记录所有敏感操作
- 定期审计安全日志
- 及时发现和处理安全问题

## 13. 性能优化

### 13.1 缓存机制

- 模板缓存
- 数据缓存
- 配置缓存

### 13.2 异步处理

- 异步API调用
- 异步文件IO
- 异步数据库操作

### 13.3 资源管理

- 资源池管理
- 连接池管理
- 内存优化

### 13.4 代码优化

- 优化算法
- 减少不必要的计算
- 避免内存泄漏

## 14. 扩展性设计

### 14.1 插件化架构

- 数据源适配器采用插件化设计
- 支持动态加载和卸载
- 便于扩展新的数据源

### 14.2 模块化设计

- 系统采用模块化设计
- 各模块之间通过接口通信
- 便于扩展新的功能模块

### 14.3 配置驱动

- 系统行为通过配置文件驱动
- 支持运行时配置调整
- 便于系统维护和管理

## 15. 开发工具

### 15.1 常用工具

| 工具 | 用途 |
|------|------|
| Visual Studio 2022 | 集成开发环境 |
| Git | 版本控制 |
| Postman | API测试 |
| SQL Server Management Studio | 数据库管理 |
| dotTrace | 性能分析 |
| Resharper | 代码质量分析 |

### 15.2 开发脚本

- 构建脚本
- 测试脚本
- 部署脚本
- 数据库迁移脚本

## 16. 总结

“杏林”病理检验报告系统采用了现代化的技术架构和设计理念，具有良好的扩展性、安全性和性能。系统支持多种部署方式，适用于不同规模的医院和诊所。通过模块化设计和插件化架构，系统便于扩展新的功能和数据源，能够满足不断变化的业务需求。

本开发文档提供了系统的技术架构、开发环境配置、编码规范、开发流程、核心模块开发、测试指南、部署指南等内容，为开发人员提供了全面的开发参考。