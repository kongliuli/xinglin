# B_技术架构

## B.1 数据库设计

### B.1.1 内网数据库
B.1.1.1 存储内容：所有已归档的检验报告，包括病人信息、检测结果、使用的模板、操作人、时间戳等。
B.1.1.2 日志记录：记录患者通过微信查询报告的日志，用于审计与安全追踪。
B.1.1.3 数据缓存：不存储原始 HIS 数据，仅缓存本次报告所需的必要信息。

### B.1.2 云端数据库
B.1.2.1 医院信息：管理所有注册医院的信息，包括医院名称、绑定的机器码、激活码、授权有效期。
B.1.2.2 模板管理：存放所有版本的报告模板（JSON 格式），支持按医院分配不同模板。
B.1.2.3 权限控制：控制每个医院的功能权限（如是否允许导出 PDF、是否允许修改已打印报告）。
B.1.2.4 心跳记录：记录客户端心跳，用于判断是否过期或被禁用。

## B.2 数据源适配器设计

### B.2.1 工作机制
B.2.1.1 插件化架构：每个数据源（如 HIS、读卡器）打包为独立 DLL，实现统一接口。
B.2.1.2 动态加载：系统启动时，根据配置文件决定加载哪些适配器。
B.2.1.3 优先级调用：用户触发"获取病人信息"时，系统按优先级调用适配器（如先读卡，失败再查 HIS）。
B.2.1.4 统一格式：所有适配器返回统一格式的病人信息对象，供界面使用。

### B.2.2 配置方式
B.2.2.1 连接参数：通过 JSON 文件定义每个适配器的连接参数（如数据库连接串、COM 口、API 地址）。
B.2.2.2 字段映射：支持字段映射，将不同系统的字段名（如 PAT_NAME）映射到统一字段（如 Name）。
B.2.2.3 启用/禁用：支持启用/禁用、设置默认激活项。

### B.2.3 扩展性
B.2.3.1 新增数据源：新增数据源只需开发新 DLL 并放入指定目录，配合配置即可生效。
B.2.3.2 测试功能：提供测试连接功能，便于信息科人员调试。