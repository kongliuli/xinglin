# 技术架构详细说明

## 1. 系统概述

“杏林”病理检验报告系统是一个面向医院检验科的本地化报告录入与打印工具，采用模块化设计，支持多源数据接入、动态模板生成和微信查询等功能。

## 2. 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| .NET | 8.0 | 核心框架 |
| WPF | 8.0 | 桌面端应用 |
| ASP.NET Core | 8.0 | 服务端应用 |
| Newtonsoft.Json | 13.0.4 | JSON序列化与反序列化 |
| PdfSharpCore | 1.3.67 | PDF生成 |
| Autofac | 8.0.0 | 依赖注入 |
| xunit | 2.5.3 | 单元测试 |
| Swashbuckle.AspNetCore | 6.6.2 | Swagger API文档 |

## 3. 系统架构

### 3.1 模块分层

系统采用经典的分层架构，分为以下几层：

| 层 | 主要职责 | 包含模块 |
|----|---------|---------|
| 表现层 | 提供用户界面 | Xinglin.ReportTemplateEditor.WPF |
| 应用层 | 处理业务流程 | 各模块的服务类 |
| 领域层 | 核心业务逻辑 | Xinglin.Core |
| 基础设施层 | 提供通用服务 | Xinglin.Infrastructure, Xinglin.Common |
| 数据访问层 | 数据持久化 | Xinglin.DataAdapters |
| 安全层 | 身份认证与授权 | Xinglin.Security |

### 3.2 核心模块关系

```
┌────────────────────────────────────────────────────────────────────────┐
│                           表现层                                      │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │                    桌面端应用                                │   │
│  │  Xinglin.ReportTemplateEditor.WPF                            │   │
│  └────────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │                     服务端应用                               │   │
│  │  Xinglin.Server.Internal                                     │   │
│  │  Xinglin.Server.External                                     │   │
│  │  Xinglin.Server.Master                                       │   │
│  └────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌────────────────────────────────────────────────────────────────────────┐
│                           应用层                                      │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │                     服务类                                    │   │
│  │  TemplateService, AuthenticationService, AuthorizationService │   │
│  └────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌────────────────────────────────────────────────────────────────────────┐
│                           领域层                                      │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │                     核心业务逻辑                              │   │
│  │  ElementBase, ReportTemplateDefinition, ICommunicationProxy    │   │
│  └────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌────────────────────────────────────────────────────────────────────────┐
│                        基础设施层                                    │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │                     通用服务                                  │   │
│  │  Dependency Injection, Logging, Configuration, Exception       │   │
│  │  Handling, Template Serialization, PDF Rendering               │   │
│  └────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌────────────────────────────────────────────────────────────────────────┐
│                           数据访问层                                  │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │                     数据适配器                                │   │
│  │  IDataAdapter, IDataConverter, IDataSourceManager            │   │
│  └────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌────────────────────────────────────────────────────────────────────────┐
│                           安全层                                      │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │                     安全服务                                  │   │
│  │  Authentication, Authorization, Encryption                   │   │
│  └────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
```

## 4. 核心模块详细设计

### 4.1 Xinglin.Core

Xinglin.Core是系统的核心业务逻辑模块，包含以下主要组件：

#### 4.1.1 元素模型

- **ElementBase**：所有模板元素的基类，实现INotifyPropertyChanged
- **TextElement**：文本元素
- **ImageElement**：图片元素
- **LineElement**：线条元素
- **其他派生元素**：矩形、椭圆、条码等

#### 4.1.2 模板定义

- **ReportTemplateDefinition**：报告模板的完整定义
- **TemplateDataBinding**：模板数据绑定定义

#### 4.1.3 服务接口

- **ITemplateSerializer**：模板序列化接口
- **ITemplateRenderer**：模板渲染接口
- **ITemplateService**：模板服务接口

### 4.2 Xinglin.Infrastructure

Xinglin.Infrastructure是系统的基础设施模块，包含以下主要组件：

#### 4.2.1 依赖注入

- **DIContainerBuilder**：依赖注入容器构建器
- 支持多种运行模式的组件注册

#### 4.2.2 日志服务

- **Logger**：实现ILogger接口的日志记录器
- 支持控制台和文件日志
- 支持日志级别配置

#### 4.2.3 模板序列化

- **JsonTemplateSerializer**：JSON模板序列化实现
- 支持多态类型序列化

#### 4.2.4 PDF渲染

- **PdfSharpTemplateRenderer**：基于PdfSharpCore的PDF渲染实现

### 4.3 Xinglin.DataAdapters

Xinglin.DataAdapters是系统的数据访问模块，包含以下主要组件：

#### 4.3.1 数据适配器

- **IDataAdapter**：数据库连接和数据操作接口
- 支持多种数据库类型

#### 4.3.2 数据转换器

- **IDataConverter**：不同数据格式之间的转换
- 支持DataTable与dynamic列表之间的转换
- 支持JSON序列化与反序列化

#### 4.3.3 数据源管理器

- **IDataSourceManager**：数据源配置和管理
- 支持数据源连接测试

### 4.4 Xinglin.Security

Xinglin.Security是系统的安全模块，包含以下主要组件：

#### 4.4.1 身份认证

- **IAuthenticationService**：用户认证、令牌生成和验证
- 支持JWT令牌

#### 4.4.2 授权管理

- **IAuthorizationService**：基于角色的访问控制
- 支持权限检查和角色管理

#### 4.4.3 加密解密

- **IEncryptionService**：数据加密、解密和哈希计算
- 支持AES、RSA加密
- 支持MD5、SHA256、SHA512哈希
- 支持PBKDF2密码哈希

## 5. 服务端模块

### 5.1 内网服务端 (Xinglin.Server.Internal)

内网服务端负责模板管理和报表生成，提供以下API：

- **模板管理API**：模板的增删改查、版本管理
- **报表生成API**：基于模板的报表生成、PDF导出
- **健康检查API**：服务健康状态检查

### 5.2 外网服务端 (Xinglin.Server.External)

外网服务端负责远程模板访问和数据同步，提供以下API：

- **远程模板访问API**：远程模板的查询、下载
- **数据同步API**：模板数据的同步、更新
- **授权验证API**：服务访问的授权验证

### 5.3 总控端 (Xinglin.Server.Master)

总控端负责系统管理和权限管理，提供以下API：

- **系统管理API**：系统配置、模块管理
- **权限管理API**：用户、角色、权限管理
- **日志管理API**：系统日志的查询、分析

## 6. 桌面端应用

桌面端应用(Xinglin.ReportTemplateEditor.WPF)是一个基于WPF的模板编辑器，包含以下主要功能：

- **模板设计**：可视化模板设计界面
- **元素编辑**：支持多种元素的添加、修改、删除
- **属性面板**：元素属性的编辑和调整
- **模板树**：模板元素的层次结构显示
- **预览功能**：实时预览模板效果
- **设置界面**：应用设置管理

## 7. 数据流程

### 7.1 模板设计流程

1. 用户在桌面端应用中创建或打开模板
2. 添加和编辑模板元素
3. 设置元素属性和数据绑定
4. 实时预览模板效果
5. 保存模板到本地或服务器

### 7.2 报表生成流程

1. 客户端从数据源获取病人信息和检测结果
2. 根据模板ID从服务器获取模板定义
3. 使用模板渲染引擎生成PDF报表
4. 预览或打印报表
5. 保存报表到本地或服务器

### 7.3 数据同步流程

1. 客户端定期向服务器请求模板更新
2. 服务器返回最新的模板列表
3. 客户端比较本地模板与服务器模板的版本
4. 下载更新的模板到本地
5. 应用新模板

## 8. 部署架构

### 8.1 单机部署

- 适用于小型医院或诊所
- 所有组件部署在同一台服务器上
- 数据存储在本地数据库

### 8.2 分布式部署

- 适用于大型医院或医疗集团
- 内网服务端部署在医院内部网络
- 外网服务端部署在云端
- 总控端部署在云端或总部服务器
- 数据存储在分布式数据库

## 9. 安全性设计

### 9.1 身份认证

- 基于JWT的身份认证
- 支持刷新令牌机制
- 支持API密钥验证

### 9.2 授权管理

- 基于角色的访问控制
- 细粒度的权限管理
- 支持动态权限分配

### 9.3 数据加密

- 敏感数据传输加密
- 密码哈希存储
- 数据库连接加密

## 10. 扩展性设计

### 10.1 插件化架构

- 数据源适配器采用插件化设计
- 支持动态加载和卸载
- 便于扩展新的数据源

### 10.2 模块化设计

- 系统采用模块化设计
- 各模块之间通过接口通信
- 便于扩展新的功能模块

### 10.3 配置驱动

- 系统行为通过配置文件驱动
- 支持运行时配置调整
- 便于系统维护和管理

## 11. 性能优化

### 11.1 缓存机制

- 模板缓存
- 数据缓存
- 配置缓存

### 11.2 异步处理

- 异步API调用
- 异步文件IO
- 异步数据库操作

### 11.3 资源管理

- 资源池管理
- 连接池管理
- 内存优化

## 12. 监控与日志

### 12.1 系统监控

- 服务健康检查
- 性能指标监控
- 错误监控

### 12.2 日志管理

- 详细的日志记录
- 支持日志级别配置
- 支持日志查询和分析

## 13. 开发规范

### 13.1 代码规范

- 遵循C#编码规范
- 采用命名空间组织代码
- 使用明确的命名约定

### 13.2 设计模式

- 采用MVVM设计模式
- 采用依赖注入
- 采用命令模式

### 13.3 测试规范

- 编写单元测试
- 编写集成测试
- 编写系统测试

## 14. 维护与支持

### 14.1 版本管理

- 语义化版本控制
- 定期发布更新
- 支持版本回滚

### 14.2 故障排查

- 详细的错误日志
- 故障诊断工具
- 远程协助支持

### 14.3 升级策略

- 无缝升级
- 数据迁移支持
- 升级向导

## 15. 总结

“杏林”病理检验报告系统采用了现代化的技术架构和设计理念，具有良好的扩展性、安全性和性能。系统支持多种部署方式，适用于不同规模的医院和诊所。通过模块化设计和插件化架构，系统便于扩展新的功能和数据源，能够满足不断变化的业务需求。