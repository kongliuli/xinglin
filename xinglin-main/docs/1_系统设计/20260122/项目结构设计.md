# 项目结构设计

## 一、项目概述

杏林病理检验报告系统采用模块化、分层架构设计，将系统划分为四个主要端点和一个共享库层，确保各组件职责清晰、高内聚低耦合。

## 二、目录结构

```
xinglin-main/
├── 0_共享库/                          # 共享基础库
│   ├── Xinglin.Core/                   # 通用模型与接口库
│   ├── Xinglin.Infrastructure/           # 数据访问与文件工具库
│   ├── Xinglin.DataAdapters/           # 数据源适配器框架
│   ├── Xinglin.Common/                 # 通用工具类库
│   └── Xinglin.Security/               # 安全与加密库
│
├── 1_桌面端/                          # WPF客户端
│   ├── Xinglin.Client.WPF/            # WPF主程序
│   ├── Xinglin.Client.Core/            # 客户端核心库（ViewModel、View等）
│   └── Xinglin.Printing.Service/       # 打印引擎服务
│
├── 2_内网服务端/                       # 内网API服务
│   ├── Xinglin.Server.Internal/         # 内网服务主程序
│   ├── Xinglin.Server.Internal.Core/    # 内网服务核心库
│   └── Xinglin.Server.Internal.API/     # 内网服务API接口
│
├── 3_外网服务端/                       # 外网API服务
│   ├── Xinglin.Server.External/         # 外网服务主程序
│   ├── Xinglin.Server.External.Core/    # 外网服务核心库
│   └── Xinglin.Server.External.API/     # 外网服务API接口
│
├── 4_总控端/                          # 主控服务端
│   ├── Xinglin.Server.Master/           # 主控服务主程序
│   ├── Xinglin.Server.Master.Core/      # 主控服务核心库
│   ├── Xinglin.Server.Master.API/       # 主控服务API接口
│   └── Xinglin.Server.Master.Library/   # 全局管理和规划类库
│
├── 9_测试/                            # 单元测试项目
│   ├── Xinglin.Core.Tests/             # 核心库测试
│   ├── Xinglin.Client.Tests/           # 客户端测试
│   ├── Xinglin.Server.Internal.Tests/   # 内网服务测试
│   ├── Xinglin.Server.External.Tests/   # 外网服务测试
│   └── Xinglin.Server.Master.Tests/    # 主控服务测试
│
├── docs/                              # 文档目录
│   └── 1_系统设计/
│       └── 20260122/                  # 本次设计文档
│
├── xinglin26.sln                      # 解决方案文件
└── README.md                          # 项目说明文档
```

## 三、各模块详细说明

### 3.1 共享库层 (0_共享库)

#### Xinglin.Core
- **类型**: 类库
- **目标框架**: .NET 8.0
- **职责**: 定义系统核心数据模型和接口
- **主要内容**:
  - 病人信息模型
  - 报告模型
  - 模板模型
  - 用户模型
  - 授权模型
  - 通用接口定义

#### Xinglin.Infrastructure
- **类型**: 类库
- **目标框架**: .NET 8.0
- **职责**: 提供数据访问和文件操作的基础设施
- **主要内容**:
  - 数据库访问层（基于SqlSugar）
  - 文件读写工具
  - 配置管理
  - 日志记录

#### Xinglin.DataAdapters
- **类型**: 类库
- **目标框架**: .NET 8.0
- **职责**: 实现插件化的数据源适配器框架
- **主要内容**:
  - 适配器接口定义
  - 适配器管理器
  - HIS数据库适配器
  - 身份证读卡器适配器
  - 第三方API适配器
  - 适配器配置管理

#### Xinglin.Common
- **类型**: 类库
- **目标框架**: .NET 8.0
- **职责**: 提供通用的工具类和扩展方法
- **主要内容**:
  - 字符串扩展
  - 日期时间工具
  - JSON序列化工具
  - 验证工具
  - 异常处理

#### Xinglin.Security
- **类型**: 类库
- **目标框架**: .NET 8.0
- **职责**: 提供安全相关的功能
- **主要内容**:
  - 加密解密工具
  - 哈希计算
  - 机器码生成
  - 签名验证
  - 权限验证

### 3.2 桌面端 (1_桌面端)

#### Xinglin.Client.WPF
- **类型**: WPF应用程序
- **目标框架**: .NET 8.0
- **职责**: WPF主程序，提供用户界面
- **主要内容**:
  - 主窗口
  - 报告录入界面
  - 报告预览界面
  - 设置界面
  - 启动配置

#### Xinglin.Client.Core
- **类型**: 类库
- **目标框架**: .NET 8.0
- **职责**: 客户端核心逻辑，MVVM架构
- **主要内容**:
  - ViewModel基类
  - 业务ViewModel
  - 服务接口
  - 命令处理
  - 消息传递

#### Xinglin.Printing.Service
- **类型**: 类库
- **目标框架**: .NET 8.0
- **职责**: 打印引擎服务
- **主要内容**:
  - A4纸精准打印
  - 报告模板渲染
  - 打印预览
  - 打印队列管理

### 3.3 内网服务端 (2_内网服务端)

#### Xinglin.Server.Internal
- **类型**: Web API
- **目标框架**: .NET 8.0
- **职责**: 内网服务主程序
- **主要内容**:
  - API控制器
  - 中间件配置
  - 启动配置
  - 依赖注入配置

#### Xinglin.Server.Internal.Core
- **类型**: 类库
- **目标框架**: .NET 8.0
- **职责**: 内网服务核心业务逻辑
- **主要内容**:
  - 报告归档服务
  - 报告查询服务
  - 数据验证
  - 业务规则

#### Xinglin.Server.Internal.API
- **类型**: 类库
- **目标框架**: .NET 8.0
- **职责**: 内网服务API接口定义
- **主要内容**:
  - API模型
  - 请求/响应DTO
  - API文档
  - 接口契约

### 3.4 外网服务端 (3_外网服务端)

#### Xinglin.Server.External
- **类型**: Web API
- **目标框架**: .NET 8.0
- **职责**: 外网服务主程序
- **主要内容**:
  - API控制器
  - 微信对接
  - 中间件配置
  - 启动配置

#### Xinglin.Server.External.Core
- **类型**: 类库
- **目标框架**: .NET 8.0
- **职责**: 外网服务核心业务逻辑
- **主要内容**:
  - 微信OAuth处理
  - 报告查询转发
  - 数据脱敏
  - HTML报告生成

#### Xinglin.Server.External.API
- **类型**: 类库
- **目标框架**: .NET 8.0
- **职责**: 外网服务API接口定义
- **主要内容**:
  - API模型
  - 请求/响应DTO
  - API文档
  - 接口契约

### 3.5 总控端 (4_总控端)

#### Xinglin.Server.Master
- **类型**: Web API
- **目标框架**: .NET 8.0
- **职责**: 主控服务主程序
- **主要内容**:
  - API控制器
  - 管理后台
  - 中间件配置
  - 启动配置

#### Xinglin.Server.Master.Core
- **类型**: 类库
- **目标框架**: .NET 8.0
- **职责**: 主控服务核心业务逻辑
- **主要内容**:
  - 授权管理服务
  - 模板管理服务
  - 心跳校验服务
  - 权限分发服务

#### Xinglin.Server.Master.API
- **类型**: 类库
- **目标框架**: .NET 8.0
- **职责**: 主控服务API接口定义
- **主要内容**:
  - API模型
  - 请求/响应DTO
  - API文档
  - 接口契约

#### Xinglin.Server.Master.Library
- **类型**: 类库
- **目标框架**: .NET 8.0
- **职责**: 全局管理和规划功能
- **主要内容**:
  - 全局配置管理
  - 版本控制
  - 统计分析
  - 系统监控

### 3.6 测试项目 (9_测试)

#### Xinglin.Core.Tests
- **类型**: xUnit测试项目
- **目标框架**: .NET 8.0
- **职责**: 测试核心库功能

#### Xinglin.Client.Tests
- **类型**: xUnit测试项目
- **目标框架**: .NET 8.0
- **职责**: 测试客户端功能

#### Xinglin.Server.Internal.Tests
- **类型**: xUnit测试项目
- **目标框架**: .NET 8.0
- **职责**: 测试内网服务功能

#### Xinglin.Server.External.Tests
- **类型**: xUnit测试项目
- **目标框架**: .NET 8.0
- **职责**: 测试外网服务功能

#### Xinglin.Server.Master.Tests
- **类型**: xUnit测试项目
- **目标框架**: .NET 8.0
- **职责**: 测试主控服务功能

## 四、设计原则

### 4.1 模块化
- 每个组件职责单一，高内聚低耦合
- 通过接口定义组件边界
- 支持独立开发和部署

### 4.2 可扩展性
- 通过插件化设计支持新功能扩展
- 数据源适配器可动态加载
- 模板系统支持版本管理

### 4.3 安全性
- 内外网隔离
- 授权控制
- 数据脱敏
- 审计日志

### 4.4 可维护性
- 清晰的分层架构
- 统一的编码规范
- 完善的文档
- 充分的单元测试

## 五、技术栈

| 组件 | 技术栈 | 说明 |
|--------|----------|------|
| 桌面端 | WPF + .NET 8.0 | MVVM架构 |
| 服务端 | ASP.NET Core Web API + .NET 8.0 | RESTful API |
| 数据访问 | SqlSugar ORM | 轻量级ORM |
| 测试框架 | xUnit | 单元测试 |
| 序列化 | System.Text.Json | JSON处理 |
| 日志 | Serilog | 结构化日志 |

## 六、项目统计

- **总项目数**: 20个
- **共享库**: 5个
- **桌面端**: 3个
- **内网服务端**: 3个
- **外网服务端**: 3个
- **总控端**: 4个
- **测试项目**: 5个