# ReportTemplateEditor.Designer 项目结构说明

## 项目概述

`ReportTemplateEditor.Designer` 是一个基于 WPF 的报告模板可视化编辑器项目，使用 .NET 9.0 框架开发。该项目提供了完整的图形化界面，用于设计和编辑报告模板。

## 技术栈

- **框架**: .NET 9.0-windows
- **UI框架**: WPF (Windows Presentation Foundation)
- **项目类型**: WinExe (Windows 可执行程序)
- **依赖项目**:
  - `ReportTemplateEditor.Core` - 核心模型和业务逻辑
  - `ReportTemplateEditor.Engine` - 模板渲染引擎

## 项目文件结构

```
ReportTemplateEditor.Designer/
├── MainWindow.xaml                    # 主窗口界面定义 (637行)
├── MainWindow.xaml.cs                 # 主窗口逻辑代码 (3526行)
├── TableDesignerWindow.xaml           # 表格设计器窗口界面 (288行)
├── TableDesignerWindow.xaml.cs        # 表格设计器逻辑代码 (800行)
├── DataPathSelectorWindow.xaml        # 数据路径选择器窗口界面 (9行)
├── DataPathSelectorWindow.xaml.cs     # 数据路径选择器逻辑代码 (46行)
├── Controls/
│   ├── DataPathSelector.xaml          # 数据路径选择控件界面
│   └── DataPathSelector.xaml.cs       # 数据路径选择控件逻辑 (361行)
├── App.xaml                           # 应用程序资源定义
├── App.xaml.cs                        # 应用程序入口逻辑
├── AssemblyInfo.cs                    # 程序集信息
├── ReportTemplateEditor.Designer.csproj  # 项目配置文件
├── MainWindow.xaml.cs.backup          # 主窗口代码备份
├── MainWindow.xaml.cs.fixed           # 主窗口代码修复版本
└── obj/                               # 编译输出目录
```

## 核心功能模块

### 1. 主窗口 (MainWindow)

#### 界面布局
- **菜单栏**: 文件、编辑、视图、工具菜单
- **工具栏**: 快速操作按钮（新建、打开、保存、撤销、重做等）
- **左侧工具箱**: 提供可拖拽的元素类型
- **中央设计画布**: 可视化设计区域，支持A4/A5纸张，纵向/横向布局
- **右侧面板**: 
  - 图层管理面板（支持上移、下移、置顶、置底）
  - 属性编辑面板（位置大小、外观、文本、数据绑定）
  - 数据预览面板

#### 主要功能

**文件操作**
- 新建模板
- 打开模板
- 保存模板
- 保存模板为
- 导出为JSON

**编辑功能**
- 撤销/重做（基于命令模式）
- 元素选择（支持单选和多选）
- 元素拖拽移动
- 元素删除

**视图功能**
- 显示/隐藏网格
- 对齐到网格
- 缩放控制（50%, 75%, 100%, 150%, 200%）
- 画布平移（鼠标中键或右键拖拽）

**工具箱元素**
- 文本 (Text)
- 标签 (Label)
- 图片 (Image)
- 表格 (Table)
- 线条 (Line)
- 矩形 (Rectangle)
- 椭圆 (Ellipse)

**属性编辑**
- **位置和大小**: X、Y坐标，宽度、高度
- **外观**: 可见性、旋转、Z轴顺序、不透明度、背景颜色、边框样式、阴影效果
- **文本**: 内容、字体、大小、粗细、样式、对齐方式、颜色
- **数据绑定**: 数据路径选择、格式字符串

**图层管理**
- 图层列表显示
- 图层顺序调整（上移、下移、置顶、置底）
- 多选支持

### 2. 表格设计器 (TableDesignerWindow)

#### 功能特点
- 可视化表格编辑界面
- 支持添加/删除行和列
- 单元格属性编辑
- 列类型配置（文本输入框、下拉选择框、复选框）
- 单元格样式设置（字体、颜色、对齐方式等）

#### 单元格属性
- 基本属性：内容、可编辑性、字体大小
- 文本样式：字体粗细、文本对齐、垂直对齐、文本颜色
- 背景样式：背景颜色
- 列类型配置：列类型、可编辑性、默认值、下拉选项

### 3. 数据路径选择器 (DataPathSelectorWindow)

#### 功能特点
- 树形结构显示数据源
- 支持搜索功能
- 自动识别集合、对象、属性类型
- 可视化图标区分不同类型

#### 数据路径节点类型
- **集合类型** (Collection): 显示集合图标
- **对象类型** (Object): 显示对象图标
- **属性类型** (Property): 显示属性图标

## 核心类说明

### UIElementWrapper
用于关联UI元素和模型元素的包装类：
```csharp
private class UIElementWrapper
{
    public TemplateElements.ElementBase ModelElement { get; set; }
    public UIElement UiElement { get; set; }
    public Border SelectionBorder { get; set; }
}
```

### 主要成员变量
- `_currentTemplate`: 当前模板定义
- `_renderer`: 模板渲染引擎
- `_dataBindingEngine`: 数据绑定引擎
- `_commandManager`: 命令管理器（撤销/重做）
- `_selectedElements`: 当前选中的元素列表
- `_primarySelectedElement`: 主选中元素
- `_elementWrappers`: 元素包装器列表

## 设计模式

### 1. 命令模式 (Command Pattern)
- 使用 `CommandManager` 管理命令执行
- 支持撤销/重做功能
- 命令类型：`ModifyElementPropertyCommand` 等

### 2. 观察者模式 (Observer Pattern)
- 命令执行事件订阅
- 属性变化通知

## 关键特性

### 1. 网格系统
- 可配置的网格大小（默认10mm）
- 网格显示/隐藏
- 网格吸附功能（可选）

### 2. 纸张设置
- 支持A4、A5纸张尺寸
- 支持纵向/横向布局
- 可配置页边距

### 3. 缩放功能
- 滑块控制缩放（10%-500%）
- 预设缩放比例（50%, 75%, 100%, 150%, 200%）
- 实际尺寸按钮

### 4. 数据绑定
- 数据路径选择器
- 格式字符串支持
- 数据预览功能

### 5. 元素交互
- 拖拽添加元素
- 鼠标选择元素
- 多选支持（Ctrl/Shift）
- 右键菜单（表格元素支持"设计表格内容"）

## 样式和资源

### 自定义样式
- `ToolboxItemStyle`: 工具箱项样式
- `PropertyGroupStyle`: 属性面板分组样式
- `PaperShadow`: 纸张阴影效果
- `PaperTextureBrush`: 打印纸纹理画笔
- `DesignCanvasBackground`: 设计画布背景

### 视觉效果
- 纸张纹理背景
- 网格线显示
- 页边距区域显示
- 元素选择边框高亮

## 依赖关系

### 外部依赖
- `ReportTemplateEditor.Core`: 提供核心模型和元素定义
- `ReportTemplateEditor.Engine`: 提供模板渲染功能

### 内置控件注册
- TextWidget
- TableWidget
- TestItemWidget
- LineWidget
- RectangleWidget
- EllipseWidget
- BarcodeWidget
- SignatureWidget
- AutoNumberWidget
- LabelWidget

## 待实现功能

根据代码注释，以下功能待实现：
- 剪切/复制/粘贴功能（菜单中已预留但未实现）
- 删除功能（菜单中已预留但未实现）

## 代码统计

- **MainWindow.xaml.cs**: 3526行（主要业务逻辑）
- **MainWindow.xaml**: 637行（界面定义）
- **TableDesignerWindow.xaml.cs**: 800行
- **TableDesignerWindow.xaml**: 288行
- **DataPathSelector.xaml.cs**: 361行

## 使用说明

1. **创建新模板**: 点击"文件" -> "新建模板"或工具栏"新建"按钮
2. **添加元素**: 从左侧工具箱拖拽元素到设计画布
3. **编辑属性**: 选中元素后，在右侧属性面板编辑属性
4. **设计表格**: 右键点击表格元素，选择"设计表格内容"
5. **数据绑定**: 在属性面板的"数据绑定"部分选择数据路径
6. **预览模板**: 点击"工具" -> "预览模板"或工具栏"预览"按钮
7. **保存模板**: 点击"文件" -> "保存模板"或工具栏"保存"按钮

## 注意事项

- 项目使用 .NET 9.0，需要相应的开发环境
- 默认模板路径硬编码在代码中（`_lastTemplatePath`）
- 网格吸附功能默认关闭，仅作为参考
- 部分功能（如剪切/复制/粘贴）尚未实现

