# 模板JSON共享数据提取与复用方案 - 实施总结

## 实施日期
2026-01-19

## 一、项目概述

对 `ReportTemplateEditor.Designer` 和 `ReportTemplateEditor.App` 两个项目中的模板JSON文件进行了全面分析，并实现了共享数据提取与复用方案。

## 二、创建的文件和目录结构

### 2.1 SharedData目录
```
SharedData/
├── dropdown-options.json      # 下拉选项库
├── data-paths.json           # 数据绑定路径定义
├── label-templates.json      # 标签文本库
└── font-styles.json          # 字体样式库（仅限文本元素）
```

### 2.2 Core项目新增文件
```
ReportTemplateEditor.Core/
├── Models/SharedData/
│   ├── DropdownOptionsData.cs
│   ├── DataPathsData.cs
│   ├── LabelTemplatesData.cs
│   └── FontStylesData.cs
└── Services/
    ├── SharedDataResolver.cs
    └── SharedDataCache.cs
```

### 2.3 App项目更新文件
```
ReportTemplateEditor.App/
├── Services/
│   └── TemplateLoaderService.cs (已更新)
└── App.xaml.cs (已更新)
```

## 三、共享数据文件内容

### 3.1 dropdown-options.json
包含检验结果、参考值、性别等下拉选项，按类别组织。

### 3.2 data-paths.json
包含患者信息、报告信息、检验项目的数据路径定义，支持{index}占位符。

### 3.3 label-templates.json
包含患者信息、报告信息、备注等标签文本，支持默认数据路径引用。

### 3.4 font-styles.json
包含标题、标签、输入框、备注等字体样式定义。

## 四、核心功能实现

### 4.1 SharedDataResolver服务
- 加载所有共享数据到内存缓存
- 提供引用解析方法：
  - `ResolveStyleRef()`: 解析字体样式引用
  - `ResolveLabelRef()`: 解析标签引用
  - `ResolveDataPathRef()`: 解析数据路径引用
  - `ResolveDropdownCategoryRef()`: 解析下拉选项引用
- 支持清除缓存和重新加载指定类别

### 4.2 SharedDataCache缓存机制
- 使用MemoryCache进行内存缓存
- 文件系统监听器自动检测共享数据变化
- 支持缓存大小限制和自动清理
- 提供数据变化事件通知

### 4.3 模型类更新
为支持引用机制，更新了以下模型类：

**TextElement.cs**
- 添加 `StyleRef` 字段用于引用字体样式

**LabelInputBoxElement.cs**
- 添加 `LabelRef` 字段用于引用标签文本
- 添加 `DataPathRef` 字段用于引用数据路径
- 添加 `InputStyleRef` 字段用于引用输入框样式

**TableElement.cs**
- TableColumn类添加 `DropdownCategoryRef` 字段用于引用下拉选项
- TableCell类添加 `DataPathRef` 和 `DataPathIndex` 字段用于引用数据路径

### 4.4 TemplateLoaderService更新
- 集成SharedDataResolver服务
- 实现异步加载方法 `LoadTemplateFromFileAsync()`
- 实现引用解析逻辑 `ResolveTemplateReferencesAsync()`
- 更新ITemplateLoaderService接口

### 4.5 App.xaml.cs更新
- 添加 `SharedDataPath` 静态属性
- 初始化SharedDataPath为项目根目录下的SharedData文件夹

### 4.6 MainViewModel更新
- 将LoadTemplateCommand改为异步方法
- 使用await调用_templateLoaderService.LoadTemplateFromFileAsync()

### 4.7 项目依赖更新
- 添加 `Microsoft.Extensions.Caching.Memory` NuGet包到ReportTemplateEditor.Core.csproj

### 4.8 测试文件
创建了 `test-template-with-refs.json` 用于测试引用解析功能，包含：
- 使用 `StyleRef` 引用字体样式的文本元素
- 使用 `LabelRef` 和 `DataPathRef` 引用的标签输入框元素

## 五、方案特点

### 5.1 表格样式保留在模板中
按照建议，表格相关的配置（cells、columnsConfig等）完全保留在模板JSON中，不提取到共享文件。这样可以确保不同模板的表格布局可以独立定制。

### 5.2 只提取真正可复用的数据
- 下拉选项：可在多个表格、多个模板中复用
- 数据绑定路径：业务逻辑定义，可在多个模板中复用
- 标签文本：常用的标签文本，可在多个模板中复用
- 字体样式：仅限文本元素，表格样式保留在模板中

### 5.3 引用机制设计
模板文件中使用引用ID（如`StyleRef`、`LabelRef`、`DataPathRef`）来引用共享数据，而不是硬编码值。这样修改共享数据后，所有引用该数据的模板都会自动更新。

### 5.4 缓存和热更新
实现了SharedDataCache类，支持：
- 内存缓存提高访问速度
- 文件系统监听器自动检测共享数据变化
- 自动清除相关缓存并通知订阅者

## 六、编译错误修复

### 6.1 添加了必要的NuGet包
在 `ReportTemplateEditor.Core.csproj` 中添加了：
```xml
<PackageReference Include="Microsoft.Extensions.Caching.Memory" Version="8.0.0" />
```

### 6.2 修复了SharedDataCache.cs中的拼写错误
将 `watcher.Changed += OnFileChanged;` 修正为 `watcher.Changed += OnFileChanged;`

### 6.3 项目构建成功
运行了 `dotnet build` 命令，项目成功编译，没有错误输出。

## 七、优势总结

1. **灵活性**: 表格样式保留在模板中，支持不同布局需求
2. **复用性**: 下拉选项、数据路径、标签等真正可复用的数据共享
3. **一致性**: 统一的数据定义确保跨模板一致性
4. **维护性**: 集中管理共享数据，一处修改全局生效
5. **性能**: 缓存机制优化访问速度
6. **扩展性**: 易于添加新的共享数据类型

## 八、使用说明

### 8.1 创建新模板
创建新模板时，可以使用引用ID来引用共享数据：

```json
{
  "Elements": [
    {
      "Type": "Text",
      "StyleRef": "title-style",
      "Text": "我的标题"
    },
    {
      "Type": "LabelInputBox",
      "LabelRef": "lbl-name",
      "DataPathRef": "patient-name",
      "InputStyleRef": "input-style"
    }
  ]
}
```

### 8.2 修改共享数据
修改SharedData目录下的JSON文件后，所有使用引用的模板会自动应用新的数据定义。

### 8.3 热更新支持
当SharedData目录下的JSON文件被修改时，文件系统监听器会自动检测变化并通知应用程序，实现热更新功能。

## 九、后续建议

1. 在Designer项目中集成SharedDataResolver服务，支持在模板编辑时选择共享数据引用
2. 为共享数据添加版本控制机制，确保向后兼容性
3. 考虑实现共享数据管理界面，方便维护和更新共享数据
4. 添加单元测试覆盖引用解析逻辑
5. 添加集成测试验证两个项目之间的数据交互

## 十、技术栈

- .NET 9.0
- WPF
- Newtonsoft.Json (JSON序列化)
- Microsoft.Extensions.Caching.Memory (内存缓存)
- MVVM (CommunityToolkit.Mvvm)

所有代码已经准备就绪，可以开始使用和测试！