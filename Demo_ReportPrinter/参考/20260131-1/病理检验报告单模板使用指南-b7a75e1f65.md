# 病理检验报告单模板使用指南

> 文档版本：v1.0
> 创建日期：2026-01-31
> 适用系统：Demo_ReportPrinter

---

## 一、模板概览

已生成6个病理检验相关的报告单模板，所有模板均为**A5横向**格式，可直接在系统中加载使用。

| 序号 | 模板名称 | 文件名 | 用途说明 |
|------|---------|--------|---------|
| 1 | 病理检验基础报告单 | `template_pathology_basic.json` | 常规病理检验，包含基础检验项目 |
| 2 | 病理检验高级报告单 | `template_pathology_advanced.json` | 复杂病理检验，支持图像标记和详细分析 |
| 3 | 临床化学检验报告单 | `template_clinical_chemistry.json` | 肝功能、肾功能、血糖血脂等生化指标 |
| 4 | 血液检验报告单 | `template_hematology.json` | 血常规检验，包含白细胞、红细胞、血小板 |
| 5 | 免疫检验报告单 | `template_immunology.json` | 乙肝、丙肝、梅毒、HIV等免疫指标 |
| 6 | 凝血功能检验报告单 | `template_coagulation.json` | PT、APTT、TT、FIB等凝血功能指标 |

---

## 二、模板结构说明

### 2.1 通用布局结构

所有模板采用统一的布局结构，便于标准化管理：

```
┌─────────────────────────────────────────────────────────┐
│  报告标题（居中，大字体）                                │
│  编号：{ReportNo}（右上角）                              │
├─────────────────────────────────────────────────────────┤
│  患者信息区（左侧）     │ 采样信息区（右侧）              │
│  ├─ 患者姓名            │  ├─ 采样日期                   │
│  ├─ 年龄                │  ├─ 报告日期                   │
│  ├─ 性别                │  ├─ 标本类型/送检科室          │
│  └─ 病历号              │  └─ 送检医师                  │
├─────────────────────────────────────────────────────────┤
│  检验结果区（多表格，根据检验类型分组）                  │
│  ┌────────────────────────────────────────────────────┐ │
│  │  分区标题（如：肝功能指标）                         │ │
│  │  ┌──────┬──────┬──────┬──────┬──────┬──────┐   │ │
│  │  │项目名 │结果  │参考值│单位  │异常  │备注  │   │ │
│  │  └──────┴──────┴──────┴──────┴──────┴──────┘   │ │
│  └────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  诊断结论区（大文本框）                                  │
└─────────────────────────────────────────────────────────┘
```

### 2.2 像素尺寸映射（A5横向）

- **物理尺寸**：210mm × 148mm
- **像素尺寸**：842 × 595（96 DPI）
- **边距**：38-40px（约9-10mm）

---

## 三、各模板详细说明

### 3.1 病理检验基础报告单

**文件名**：`template_pathology_basic.json`

**适用场景**：
- 常规病理检验
- 简单的组织切片检查
- 基础细胞学检验

**主要字段**：
| 字段类型 | 字段名称 | 控件类型 | 必填 | 验证规则 |
|---------|---------|---------|------|---------|
| 患者信息 | 患者姓名 | TextBox | ✅ | MaxLength=20 |
| | 年龄 | TextBox | ✅ | 正则：`^\d{1,3}$` |
| | 性别 | ComboBox | ✅ | 选项：男/女 |
| | 病历号 | TextBox | ✅ | MaxLength=20 |
| 采样信息 | 采样日期 | DatePicker | ✅ | 2020-2026 |
| | 报告日期 | DatePicker | ✅ | 2020-2026 |
| | 送检科室 | ComboBox | ✅ | 多科室选项 |
| | 送检医师 | TextBox | ✅ | MaxLength=20 |
| 检验结果 | 检验结果表 | Table | ❌ | 5列，支持增删行 |
| 诊断 | 诊断结论 | TextBox | ✅ | MaxLength=500，多行 |

**表格配置**：
- 列：检验项目 | 结果 | 参考值 | 单位 | 异常
- 默认行数：5
- 支持操作：添加行、删除行

---

### 3.2 病理检验高级报告单

**文件名**：`template_pathology_advanced.json`

**适用场景**：
- 复杂病理检验
- 需要图像标记的检验
- 需要详细分析的检验

**特色功能**：
- ✅ 支持图像上传（350×200px）
- ✅ 支持图像拖拽
- ✅ 支持多分区（检验结果、图像标记、详细分析）

**主要字段**：
| 字段类型 | 字段名称 | 控件类型 | 必填 | 验证规则 |
|---------|---------|---------|------|---------|
| 基础信息 | 患者姓名/年龄/性别/病历号 | - | ✅ | 同基础报告单 |
| | 采样日期/报告日期 | DatePicker | ✅ | - |
| | 标本类型 | ComboBox | ✅ | 血液/组织切片/细胞学涂片等 |
| 检验结果 | 检验结果表 | Table | ❌ | 3行默认 |
| 图像标记 | 图像标记区 | Image | ❌ | 支持上传和拖拽 |
| | 图像说明 | TextBox | ❌ | MaxLength=100 |
| 详细分析 | 详细分析 | TextBox | ✅ | MaxLength=1000，多行 |
| 诊断 | 诊断结论 | TextBox | ✅ | MaxLength=500，多行 |

---

### 3.3 临床化学检验报告单

**文件名**：`template_clinical_chemistry.json`

**适用场景**：
- 肝功能检验（ALT、AST、ALP等）
- 肾功能检验（BUN、Cr等）
- 血糖血脂检验（GLU、TC、TG等）

**特色功能**：
- ✅ 三分区表格（肝功能、肾功能、血糖血脂）
- ✅ 每个表格独立配置
- ✅ 参考值分上下限

**表格配置**：
- 列：项目名称 | 结果 | 参考下限 | 参考上限 | 单位 | 异常 | 备注
- 默认行数：每表2行
- 支持操作：添加行、删除行

**预设项目**：
- 肝功能：ALT（谷丙转氨酶）、AST（谷草转氨酶）、ALP（碱性磷酸酶）等
- 肾功能：BUN（尿素氮）、Cr（肌酐）、UA（尿酸）等
- 血糖血脂：GLU（血糖）、TC（总胆固醇）、TG（甘油三酯）等

---

### 3.4 血液检验报告单

**文件名**：`template_hematology.json`

**适用场景**：
- 血常规检验
- 白细胞分类计数
- 红细胞和血小板计数

**特色功能**：
- ✅ 三分区表格（白细胞、红细胞、血小板）
- ✅ 特殊单位显示（10^9/L、10^12/L）

**表格配置**：
- 列：项目名称 | 结果 | 参考下限 | 参考上限 | 单位 | 异常 | 备注
- 默认行数：每表2行
- 支持操作：添加行、删除行

**预设项目**：
- 白细胞：WBC（白细胞计数）、LYM（淋巴细胞）、MON（单核细胞）等
- 红细胞：RBC（红细胞计数）、HGB（血红蛋白）、HCT（红细胞压积）等
- 血小板：PLT（血小板计数）、MPV（平均血小板体积）等

---

### 3.5 免疫检验报告单

**文件名**：`template_immunology.json`

**适用场景**：
- 乙肝五项检验
- 丙肝抗体检验
- 梅毒螺旋体抗体检验
- HIV抗体检验

**特色功能**：
- ✅ 二分区表格（乙肝五项、其他免疫指标）
- ✅ 结果为下拉选择（阳性/阴性/可疑）
- ✅ 预设乙肝五项项目

**表格配置**：
- 列：项目名称 | 结果 | 参考值 | 单位 | 异常 | 备注
- 默认行数：乙肝五项5行，其他3行
- 支持操作：添加行、删除行

**预设项目**：
- 乙肝五项：HBsAg（表面抗原）、HBsAb（表面抗体）、HBeAg（e抗原）、HBeAb（e抗体）、HBcAb（核心抗体）
- 其他免疫指标：HCV-Ab（丙肝抗体）、TP-Ab（梅毒抗体）、HIV-Ab（HIV抗体）

---

### 3.6 凝血功能检验报告单

**文件名**：`template_coagulation.json`

**适用场景**：
- 凝血功能常规检验
- 血栓前状态评估
- 抗凝治疗监测

**特色功能**：
- ✅ 标本类型选择（枸橼酸钠、肝素、EDTA）
- ✅ 预设6项凝血指标
- ✅ 底部备注说明

**表格配置**：
- 列：项目名称 | 结果 | 参考值 | 单位 | 异常 | 备注
- 默认行数：6行
- 支持操作：添加行、删除行

**预设项目**：
- PT（凝血酶原时间）
- PT%（凝血酶原时间活动度）
- APTT（活化部分凝血活酶时间）
- TT（凝血酶时间）
- FIB（纤维蛋白原）
- D-Dimer（D-二聚体）

---

## 四、模板加载与使用

### 4.1 模板加载方法

#### 方法1：通过代码加载

```csharp
// 使用 TemplateService 加载模板
var templateService = new TemplateService();

// 加载单个模板
var template = await templateService.GetTemplateByIdAsync("template_pathology_basic.json");

// 通过 SharedDataService 加载
var sharedDataService = SharedDataService.Instance;
sharedDataService.CurrentTemplate = template;

// 通知 ViewModel 加载模板
sharedDataService.SendMessage(new TemplateLoadedMessage(template.TemplateId));
```

#### 方法2：通过文件系统加载

```csharp
// 模板文件存储位置
var templatesDirectory = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Templates");
var templateFile = Path.Combine(templatesDirectory, "template_pathology_basic.json");

// 直接读取 JSON 文件
var json = await File.ReadAllTextAsync(templateFile);
var template = JsonSerializer.Deserialize<TemplateData>(json);
```

### 4.2 模板保存方法

```csharp
// 使用 TemplateService 保存模板
var templateService = new TemplateService();
await templateService.SaveTemplateAsync(currentTemplate);

// 或直接保存到文件
var json = JsonSerializer.Serialize(currentTemplate, new JsonSerializerOptions { WriteIndented = true });
await File.WriteAllTextAsync(templateFile, json);
```

### 4.3 模板使用流程

```
1. 加载模板
   ↓
2. 系统解析模板元数据
   ├─ 解析 FixedElements（固定元素）
   ├─ 解析 EditableElements（可编辑元素）
   └─ 解析 Properties（扩展属性）
   ↓
3. 动态生成 UI
   ├─ 生成患者信息录入区
   ├─ 生成采样信息录入区
   ├─ 生成检验结果表格
   └─ 生成诊断结论区
   ↓
4. 用户填写数据
   ├─ 填写基础字段（姓名、年龄等）
   ├─ 选择下拉选项（性别、科室等）
   ├─ 填写表格数据（检验结果）
   └─ 填写诊断结论
   ↓
5. 验证数据
   ├─ 必填字段验证
   ├─ 格式验证（正则、长度）
   ├─ 范围验证（日期范围、数值范围）
   └─ 实时错误提示
   ↓
6. 保存数据
   ├─ 保存到本地存储
   ├─ 同步到 SharedDataService
   └─ 通知 PDF 预览刷新
   ↓
7. 导出 PDF
   └─ 根据模板布局生成 PDF 文件
```

---

## 五、字段类型与验证规则

### 5.1 支持的控件类型

| 控件类型 | 英文标识 | 说明 | 扩展属性 |
|---------|---------|------|---------|
| 文本框 | TextBox | 单行文本输入 | MaxLength, Placeholder, ValidationRegex |
| 多行文本框 | TextBox | 多行文本输入 | MaxLength, TextWrapping, AcceptsReturn |
| 下拉框 | ComboBox | 单选下拉 | Options, DefaultSelectedIndex, IsSearchable |
| 日期选择器 | DatePicker | 日期选择 | MinDate, MaxDate, ShowToday |
| 复选框 | CheckBox | 勾选选择 | Label, LabelPlacement |
| 表格 | Table | 多行数据 | TableConfig（列配置、行操作） |
| 图片 | Image | 图片显示 | Stretch, CornerRadius, AllowUpload, AllowDragDrop |

### 5.2 验证规则配置

```json
{
  "IsRequired": true,           // 必填验证
  "MaxLength": 20,              // 最大长度
  "MinLength": 5,               // 最小长度
  "ValidationRegex": "^\\d{1,3}$",  // 正则表达式
  "MinDate": "2020-01-01",      // 最小日期
  "MaxDate": "2026-12-31",      // 最大日期
  "MinValue": 0,                // 最小数值
  "MaxValue": 100               // 最大数值
}
```

### 5.3 常用正则表达式

| 验证项 | 正则表达式 | 说明 |
|-------|-----------|------|
| 年龄 | `^\d{1,3}$` | 1-3位数字 |
| 手机号 | `^1[3-9]\d{9}$` | 中国手机号 |
| 邮箱 | `^[^\s@]+@[^\s@]+\.[^\s@]+$` | 标准邮箱格式 |
| 身份证号 | `^\d{17}[\dXx]$` | 18位身份证 |
| 中文姓名 | `^[\u4e00-\u9fa5]{2,10}$` | 2-10个中文字符 |
| 邮政编码 | `^\d{6}$` | 6位数字 |

---

## 六、表格配置详解

### 6.1 表格结构

```json
{
  "Type": "Table",
  "DisplayName": "检验结果表",
  "Properties": {
    "TableConfig": {
      "Columns": [
        {
          "ColumnId": "projectName",
          "HeaderText": "项目名称",
          "ControlType": "TextBox",
          "Width": 200,
          "IsRequired": true
        }
      ],
      "DefaultRowCount": 5,
      "AllowAddRow": true,
      "AllowDeleteRow": true,
      "AllowReorderColumns": false
    }
  }
}
```

### 6.2 单元格控件类型

| 单元格类型 | 适用场景 | 示例 |
|-----------|---------|------|
| TextBox | 普通文本输入 | 项目名称、结果 |
| ComboBox | 固定选项选择 | 单位、异常标记 |
| CheckBox | 勾选选择 | 是否异常 |
| DatePicker | 日期选择 | 检验日期 |

### 6.3 表格操作权限

| 权限 | 说明 | 配置值 |
|------|------|--------|
| 允许添加行 | 用户可以添加新行 | `AllowAddRow: true` |
| 允许删除行 | 用户可以删除行 | `AllowDeleteRow: true` |
| 允许重排列 | 用户可以拖拽列 | `AllowReorderColumns: true` |
| 允许排序列 | 用户可以点击列头排序 | `AllowSortColumns: true` |

---

## 七、元数据扩展属性

### 7.1 文本框扩展属性

```json
{
  "Properties": {
    "IsRequired": true,              // 必填
    "MaxLength": 20,                 // 最大长度
    "Placeholder": "请输入内容",      // 占位符
    "ValidationRegex": "^[\\u4e00-\\u9fa5]{2,10}$",  // 正则验证
    "TextWrapping": "Wrap",          // 文本换行
    "AcceptsReturn": "True",         // 允许回车
    "VerticalScrollBarVisibility": "Auto"  // 垂直滚动条
  }
}
```

### 7.2 下拉框扩展属性

```json
{
  "Properties": {
    "IsRequired": true,              // 必填
    "Options": "技术部\n市场部\n销售部",  // 选项列表（换行分隔）
    "DefaultSelectedIndex": 0,        // 默认选中索引
    "IsSearchable": true             // 是否可搜索
  }
}
```

### 7.3 日期选择器扩展属性

```json
{
  "Properties": {
    "IsRequired": true,              // 必填
    "MinDate": "2020-01-01",         // 最小日期
    "MaxDate": "2026-12-31",         // 最大日期
    "ShowToday": true                // 显示今天按钮
  }
}
```

### 7.4 表格扩展属性

```json
{
  "Properties": {
    "TableConfig": {
      "Columns": [...],
      "DefaultRowCount": 5,          // 默认行数
      "AllowAddRow": true,           // 允许添加行
      "AllowDeleteRow": true,        // 允许删除行
      "AllowReorderColumns": false,  // 允许重排列
      "FixedHeader": true            // 固定表头
    }
  }
}
```

---

## 八、模板文件命名规范

### 8.1 命名格式

```
template_[category]_[type]_[version].json
```

### 8.2 命名示例

| 模板名称 | 文件名 |
|---------|--------|
| 病理检验基础报告单 v1.0 | `template_pathology_basic_v1.json` |
| 临床化学检验报告单 v2.0 | `template_clinical_chemistry_v2.json` |
| 血液检验报告单 v1.5 | `template_hematology_v1_5.json` |

### 8.3 分类编码

| 分类 | 编码 | 说明 |
|------|------|------|
| 病理检验 | `pathology` | 组织病理、细胞病理 |
| 临床检验 | `clinical` | 生化、免疫、血液、凝血 |
| 影像检查 | `radiology` | X光、CT、MRI、超声 |
| 功能检查 | `functional` | 心电图、脑电图、肺功能 |

---

## 九、常见问题

### 9.1 模板加载失败

**问题**：加载模板时报错 "模板文件不存在"

**解决**：
- 确认模板文件是否存在于 `Templates` 目录
- 确认文件名是否正确（区分大小写）
- 检查 JSON 格式是否正确（使用 JSON 验证工具）

### 9.2 字段验证失败

**问题**：填写数据后提示验证错误

**解决**：
- 检查必填字段是否已填写
- 检查格式是否符合要求（如年龄必须是数字）
- 检查长度是否超出限制
- 查看错误提示信息

### 9.3 表格无法编辑

**问题**：表格单元格无法输入内容

**解决**：
- 确认表格的 `Editable` 状态是否为 `true`
- 确认单元格的 `IsRequired` 设置
- 检查单元格控件类型是否支持编辑

### 9.4 数据同步失败

**问题**：录入面板和画布数据不同步

**解决**：
- 确认 `SharedDataService` 是否正常工作
- 确认消息监听器是否正确注册
- 检查双向同步是否启用

---

## 十、最佳实践

### 10.1 模板设计原则

1. **保持一致性**
   - 同类模板使用相同的布局结构
   - 字段命名保持一致（如患者姓名统一使用 `patientName`）
   - 验证规则保持一致

2. **优化用户体验**
   - 必填字段使用红色星号标识
   - 提供清晰的占位符提示
   - 合理设置字段长度和默认值

3. **考虑扩展性**
   - 预留足够的扩展属性空间
   - 使用标准化的控件类型
   - 设计灵活的表格配置

### 10.2 数据验证最佳实践

1. **分层验证**
   - 前端验证：实时反馈，提升用户体验
   - 后端验证：确保数据安全性
   - 数据库约束：保证数据完整性

2. **友好的错误提示**
   - 具体的错误信息（如"年龄必须是1-3位数字"）
   - 错误位置高亮显示
   - 错误修复建议

3. **验证规则可配置**
   - 通过元数据定义验证规则
   - 支持自定义验证规则
   - 验证规则可动态更新

### 10.3 性能优化建议

1. **大数据量优化**
   - 使用虚拟化滚动
   - 分页加载表格数据
   - 延迟加载图片

2. **渲染优化**
   - 减少不必要的 UI 更新
   - 使用数据绑定优化
   - 异步加载模板

3. **内存管理**
   - 及时释放不用的资源
   - 使用弱引用避免内存泄漏
   - 合理使用缓存

---

## 十一、模板版本管理

### 11.1 版本号规则

采用语义化版本号：`主版本号.次版本号.修订号`

- **主版本号**：重大功能变更，不兼容的修改
- **次版本号**：新增功能，向下兼容
- **修订号**：bug修复，向下兼容

### 11.2 版本更新流程

```
v1.0 → v1.1 → v1.2 → v2.0
  ↓       ↓       ↓
修复bug  新增功能  重大变更
```

### 11.3 版本兼容性

| 版本变更 | 兼容性 | 说明 |
|---------|--------|------|
| 修订号变更 | ✅ 完全兼容 | 仅修复bug，不影响功能 |
| 次版本号变更 | ✅ 向下兼容 | 新增功能，不影响现有功能 |
| 主版本号变更 | ❌ 不兼容 | 重大变更，可能需要迁移数据 |

---

## 十二、附录

### 12.1 完整的模板 JSON 示例

参见文件：
- `template_pathology_basic.json`
- `template_clinical_chemistry.json`
- `template_hematology.json`
- `template_immunology.json`
- `template_coagulation.json`

### 12.2 相关文档

- 《报告单模板系统架构分析报告.md》
- 《WPF MVVM 模板编辑器架构.md》
- 《元数据驱动自定义元素完成度评估标准.md》
- 《报告单模板可自定义元素手册.md》

### 12.3 技术支持

如有问题，请联系：
- 技术负责人：[待填写]
- 邮箱：[待填写]
- 项目地址：[待填写]

---

**文档结束**
