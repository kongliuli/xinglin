# æŠ¥å‘Šå•æ¨¡æ¿ç³»ç»Ÿæ¶æ„åˆ†ææŠ¥å‘Š

> æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0  
> åˆ›å»ºæ—¥æœŸï¼š2026-01-31  
> åˆ†æå¯¹è±¡ï¼šDemo_ReportPrinteré¡¹ç›®çš„ViewModelä¸æ¨¡æ¿æœåŠ¡äº¤äº’  
> åˆ†æç»´åº¦ï¼šæ•°æ®æµã€å…³è”ç¨‹åº¦ã€ç¼ºé™·è¯†åˆ«ã€æ”¹è¿›æ€è·¯

---

## ä¸€ã€æ‰§è¡Œæ‘˜è¦

### 1.1 æ•´ä½“è¯„ä¼°

ç»è¿‡å¯¹ä¸‰ä¸ªæ ¸å¿ƒViewModelï¼ˆDataEntryViewModelã€TemplateEditorViewModelã€PdfPreviewViewModelï¼‰ä¸TemplateServiceçš„æ·±åº¦åˆ†æï¼Œ**å½“å‰ç³»ç»Ÿæ¶æ„è®¾è®¡åˆç†ï¼Œæ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼Œä½†å­˜åœ¨æ•°æ®å…³è”è–„å¼±ã€åŒæ­¥æœºåˆ¶ä¸å®Œå–„ç­‰å…³é”®é—®é¢˜**ã€‚

| ç»´åº¦ | å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | å·®è·è¯„åˆ† |
|------|---------|---------|----------|
| **æ•°æ®å½•å…¥ä¸æ¨¡æ¿ç»‘å®š** | 50% | 95% | â­â­â­ |
| **æ•°æ®æµè½¬å®Œæ•´æ€§** | 60% | 95% | â­â­â­ |
| **æ¶æ„è§£è€¦åº¦** | 70% | 90% | â­â­ |
| **å¯ç»´æŠ¤æ€§** | 75% | 90% | â­â­ |
| **æ‰©å±•æ€§** | 65% | 85% | â­â­â­ |

### 1.2 æ ¸å¿ƒå‘ç°

#### âœ… ä¼˜åŠ¿

1. **æ¶ˆæ¯é€šä¿¡æœºåˆ¶å¥å…¨**ï¼šä½¿ç”¨WeakReferenceMessengerå®ç°è·¨ViewModelé€šä¿¡
2. **æ’¤é”€é‡åšç³»ç»Ÿå®Œæ•´**ï¼šTemplateEditorViewModelå®ç°äº†CommandHistory
3. **æ¨¡æ¿ç‰ˆæœ¬æ§åˆ¶**ï¼šTemplateServiceæ”¯æŒè‡ªåŠ¨ç‰ˆæœ¬ä¿å­˜
4. **å¼‚æ­¥å¤„ç†è§„èŒƒ**ï¼šæ‰€æœ‰æ–‡ä»¶æ“ä½œä½¿ç”¨async/await

#### âš ï¸ å…³é”®é—®é¢˜

1. **ç¡¬ç¼–ç æ•°æ®ç»‘å®š**ï¼šDataEntryViewModelçš„å±æ€§åä¸æ¨¡æ¿ElementIdæ— è‡ªåŠ¨å…³è”
2. **æ•°æ®åŒæ­¥ä¸å®Œæ•´**ï¼šæ¨¡æ¿ç¼–è¾‘å™¨çš„æ§ä»¶å€¼æ›´æ–°åï¼Œæ•°æ®å½•å…¥é¢æ¿æ— åå‘åŒæ­¥
3. **PDFé¢„è§ˆè§¦å‘æœºåˆ¶ä¸å¯é **ï¼šä¾èµ–æ¶ˆæ¯ç›‘å¬ï¼Œç¼ºå°‘ä¸»åŠ¨åˆ·æ–°æœºåˆ¶
4. **è¡¨æ ¼å…ƒç´ æ•°æ®æµæ–­è£‚**ï¼šTableå…ƒç´ çš„Valueç±»å‹å¤æ‚ï¼Œæœªå®ç°ä¸å½•å…¥é¢æ¿çš„æ˜ å°„

### 1.3 ä¸šåŠ¡å½±å“

| é—®é¢˜ | å½±å“èŒƒå›´ | ä¸šåŠ¡åæœ | ä¼˜å…ˆçº§ |
|------|---------|---------|--------|
| ç¡¬ç¼–ç ç»‘å®š | æ‰€æœ‰TextBox/ComboBox | æ–°å¢å­—æ®µéœ€ä¿®æ”¹å¤šå¤„ä»£ç ï¼Œç»´æŠ¤æˆæœ¬é«˜ | ğŸ”´ é«˜ |
| æ•°æ®åŒæ­¥å•å‘ | æ¨¡æ¿ç¼–è¾‘å™¨ | ç”¨æˆ·åœ¨ç”»å¸ƒä¿®æ”¹å€¼åï¼Œå½•å…¥é¢æ¿ä¸åŒæ­¥ | ğŸŸ¡ ä¸­ |
| PDFè§¦å‘ä¾èµ– | PDFé¢„è§ˆ | æ•°æ®ä¿å­˜åå¯èƒ½ä¸åˆ·æ–°é¢„è§ˆ | ğŸŸ¡ ä¸­ |
| è¡¨æ ¼æ•°æ®æ–­è£‚ | Tableå…ƒç´  | è¡¨æ ¼æ•°æ®æ— æ³•ä¸å½•å…¥é¢æ¿äº¤äº’ | ğŸ”´ é«˜ |

---

## äºŒã€å½“å‰æ•°æ®æµåˆ†æ

### 2.1 å®é™…æ•°æ®æµè½¬è·¯å¾„

#### è·¯å¾„1ï¼šæ•°æ®å½•å…¥ â†’ æ¨¡æ¿ç¼–è¾‘å™¨ âœ…

```mermaid
sequenceDiagram
    participant DE as DataEntryViewModel
    participant SDS as SharedDataService
    participant TE as TemplateEditorViewModel
    participant CT as CurrentTemplate
    participant PP as PdfPreviewViewModel

    DE->>DE: OnUserNameChanged("å¼ ä¸‰")
    DE->>SDS: UpdateUserData("UserName", "å¼ ä¸‰")
    SDS->>SDS: BroadcastDataChange("UserName", "å¼ ä¸‰")
    SDS->>TE: Send Message(DataChangedMessage)
    TE->>TE: Handle DataChangedMessage
    TE->>CT: Find element with ElementId == "UserName"
    CT->>CT: element.Value = "å¼ ä¸‰"
    Note over CT: ç”»å¸ƒä¸Šå¯¹åº”æ§ä»¶å€¼æ›´æ–°

    DE->>SDS: BroadcastDataChange("DataSaved", true)
    SDS->>PP: Send Message(DataChangedMessage)
    PP->>PP: RefreshPdfPreview()
    Note over PP: PDFé‡æ–°ç”Ÿæˆå¹¶æ˜¾ç¤º
```

**æµç¨‹è¯„ä»·**ï¼š
- âœ… å•å‘æ•°æ®æµæ¸…æ™°
- âœ… æ¶ˆæ¯å¹¿æ’­æœºåˆ¶æœ‰æ•ˆ
- âœ… æ¨¡æ¿æŸ¥æ‰¾é€»è¾‘æ­£ç¡®
- âš ï¸ **å…³é”®ç¼ºé™·**ï¼šä¾èµ–ç¡¬ç¼–ç Keyï¼ˆ"UserName"ï¼‰ï¼Œä¸æ¨¡æ¿ElementIdæ— å¼ºåˆ¶å…³è”

#### è·¯å¾„2ï¼šæ¨¡æ¿ç¼–è¾‘å™¨ â†’ æ•°æ®å½•å…¥ âŒ

```mermaid
sequenceDiagram
    participant TE as TemplateEditorViewModel
    participant CT as CurrentTemplate
    participant DE as DataEntryViewModel

    TE->>TE: SetDefaultValue(element)
    TE->>CT: element.Value = "æ–°é»˜è®¤å€¼"
    Note over CT: é—®é¢˜ï¼šæ²¡æœ‰åå‘åŒæ­¥æœºåˆ¶
    Note over DE: DataEntryViewModelæ— æ³•æ”¶åˆ°é€šçŸ¥
    Note over DE: å±æ€§å€¼ä¿æŒä¸å˜
```

**æµç¨‹è¯„ä»·**ï¼š
- âŒ **å®Œå…¨ç¼ºå¤±**ï¼šæ¨¡æ¿ç¼–è¾‘å™¨ä¿®æ”¹æ§ä»¶å€¼åï¼Œæ•°æ®å½•å…¥é¢æ¿ä¸ä¼šæ›´æ–°
- âŒ ç”¨æˆ·åœ¨ç”»å¸ƒä¸Šç›´æ¥ä¿®æ”¹çš„å€¼ï¼Œä¸ä¼šåŒæ­¥å›å½•å…¥ç•Œé¢

#### è·¯å¾„3ï¼šæ¨¡æ¿ç¼–è¾‘å™¨ â†’ PDFé¢„è§ˆ âš ï¸

```mermaid
sequenceDiagram
    participant TE as TemplateEditorViewModel
    participant SDS as SharedDataService
    participant PP as PdfPreviewViewModel

    TE->>TE: SaveTemplateAsync()
    TE->>TS: SaveTemplateAsync(CurrentTemplate)
    Note over TS: æ¨¡æ¿ä¿å­˜åˆ°æ–‡ä»¶
    Note over TE: é—®é¢˜ï¼šæœªå‘é€"TemplateChanged"æ¶ˆæ¯
    Note over PP: PdfPreviewViewModelä¸ä¼šåˆ·æ–°
```

**æµç¨‹è¯„ä»·**ï¼š
- âš ï¸ **ä¾èµ–éšå¼è§¦å‘**ï¼šSaveTemplateAsyncæ²¡æœ‰ä¸»åŠ¨å‘é€æ¶ˆæ¯
- âš ï¸ å¦‚æœç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹æ¨¡æ¿æ–‡ä»¶ï¼ˆå¤–éƒ¨ç¼–è¾‘ï¼‰ï¼ŒPDFé¢„è§ˆä¸ä¼šåˆ·æ–°
- âœ… é€šè¿‡"DataSaved"æ¶ˆæ¯å¯ä»¥è§¦å‘ï¼Œä½†é€»è¾‘ä¸å¤Ÿå¥å£®

### 2.2 æ•°æ®æµå®Œæ•´åº¦çŸ©é˜µ

| æº â†’ ç›®æ ‡ | å½“å‰æ”¯æŒ | å®ç°æ–¹å¼ | å®Œæ•´åº¦ |
|-----------|---------|---------|--------|
| DataEntry â†’ TemplateEditor | âœ… | WeakReferenceMessenger | 100% |
| DataEntry â†’ PdfPreview | âœ… | WeakReferenceMessenger | 90% |
| TemplateEditor â†’ DataEntry | âŒ | æ—  | 0% |
| TemplateEditor â†’ PdfPreview | âš ï¸ | éšå¼è§¦å‘ | 50% |
| DataEntry â†’ TemplateService | âœ… | ç›´æ¥è°ƒç”¨ | 100% |
| TemplateService â†’ DataEntry | âŒ | æ—  | 0% |

**ç»“è®º**ï¼šæ•°æ®æµæ˜¯**å•å‘ä¸”ä¸å®Œæ•´**çš„ï¼Œç¼ºå¤±å…³é”®çš„åå‘åŒæ­¥è·¯å¾„ã€‚

---

## ä¸‰ã€æ ¸å¿ƒç¼ºé™·æ·±åº¦åˆ†æ

### 3.1 ç¡¬ç¼–ç æ•°æ®ç»‘å®šé—®é¢˜

#### é—®é¢˜è¡¨ç°

```csharp
// DataEntryViewModel.cs - ç¬¬21-34è¡Œ
partial void OnUserNameChanged(string value)
{
    _sharedDataService.UpdateUserData("UserName", value);
}

partial void OnEmailChanged(string value)
{
    _sharedDataService.UpdateUserData("Email", value);
}
```

```csharp
// TemplateEditorViewModel.cs - ç¬¬394-405è¡Œ
private void UpdateElementValue(string key, object value)
{
    var element = CurrentTemplate.Layout.EditableElements
        .FirstOrDefault(e => e.ElementId == key);
    if (element != null)
    {
        element.Value = value;
    }
}
```

#### æ ¹æœ¬åŸå› 

1. **å­—ç¬¦ä¸²ç¡¬ç¼–ç **ï¼š`"UserName"`ã€`"Email"`ç­‰Keyä¸æ¨¡æ¿ä¸­çš„`ElementId`æ— ä»»ä½•çº¦æŸ
2. **æ— è‡ªåŠ¨æ˜ å°„**ï¼šå¼€å‘äººå‘˜éœ€è¦æ‰‹åŠ¨ç¡®ä¿ä¸¤è¾¹Keyä¸€è‡´
3. **è¿è¡Œæ—¶é”™è¯¯**ï¼šæ‹¼å†™é”™è¯¯æˆ–IDå˜æ›´ä¼šå¯¼è‡´æ•°æ®æ— æ³•åŒæ­¥

#### å½±å“èŒƒå›´

| åœºæ™¯ | å½±å“ |
|------|------|
| æ–°å¢å­—æ®µ | éœ€è¦åœ¨3å¤„ä¿®æ”¹ï¼šDataEntryViewModelã€TemplateElementã€TemplateEditor |
| å­—æ®µé‡å‘½å | éœ€å…¨å±€æœç´¢æ›¿æ¢ï¼Œå®¹æ˜“é—æ¼ |
| æ¨¡æ¿å¤åˆ¶ | ElementIdå˜åŒ–ï¼Œç»‘å®šå¤±æ•ˆ |
| å¤šæ¨¡æ¿æ”¯æŒ | æ— æ³•æ ¹æ®ä¸åŒæ¨¡æ¿åŠ¨æ€è°ƒæ•´å½•å…¥å­—æ®µ |

### 3.2 æ•°æ®åŒæ­¥å•å‘é—®é¢˜

#### é—®é¢˜è¡¨ç°

**åœºæ™¯1ï¼šåœ¨ç”»å¸ƒä¸Šç›´æ¥ä¿®æ”¹æ§ä»¶å€¼**

```csharp
// TemplateEditorViewModel.cs - ç¬¬156-200è¡Œ
[RelayCommand]
private void SetDefaultValue(ControlElement element)
{
    // ...å¼¹å‡ºå¯¹è¯æ¡†è®¾ç½®å€¼...
    if (window.ShowDialog() == true)
    {
        element.Value = textBox.Text;
        // é—®é¢˜ï¼šæ²¡æœ‰å‘é€DataChangedMessage
        // DataEntryViewModelæ— æ³•æ”¶åˆ°æ›´æ–°
    }
}
```

**åœºæ™¯2ï¼šä»å¤–éƒ¨åŠ è½½æ¨¡æ¿**

```csharp
[RelayCommand]
private async Task LoadTemplateAsync(string templateId)
{
    var templateService = new TemplateService();
    CurrentTemplate = await templateService.GetTemplateByIdAsync(templateId);
    // é—®é¢˜ï¼šæ¨¡æ¿åŠ è½½åï¼ŒDataEntryViewModelæ— æ³•è·å–åˆ°æ–°æ¨¡æ¿çš„æ•°æ®å­—æ®µ
}
```

#### æ ¹æœ¬åŸå› 

1. **åŒå‘ç»‘å®šæœªå®ç°**ï¼šåªæœ‰DataEntry â†’ Templateçš„å•å‘ç»‘å®š
2. **æ¨¡æ¿å˜æ›´äº‹ä»¶ç¼ºå¤±**ï¼šæ²¡æœ‰"TemplateLoaded"æˆ–"ElementChanged"äº‹ä»¶
3. **è§†å›¾æ¨¡å‹éš”ç¦»**ï¼šä¸‰ä¸ªViewModelä¹‹é—´åªèƒ½é€šè¿‡SharedDataServiceé—´æ¥é€šä¿¡

#### ä¸šåŠ¡å½±å“

| ç”¨æˆ·æ“ä½œ | é¢„æœŸè¡Œä¸º | å®é™…è¡Œä¸º | å½±å“ |
|---------|---------|---------|------|
| åœ¨ç”»å¸ƒä¸Šä¿®æ”¹æ–‡æœ¬æ¡†é»˜è®¤å€¼ | å½•å…¥é¢æ¿åŒæ­¥æ›´æ–° | å½•å…¥é¢æ¿å€¼ä¸å˜ | âŒ ç”¨æˆ·å›°æƒ‘ |
| åŠ è½½æ–°æ¨¡æ¿ | å½•å…¥é¢æ¿æ˜¾ç¤ºæ–°æ¨¡æ¿å­—æ®µ | å­—æ®µä¸æ›´æ–° | âŒ æ•°æ®é”™ä½ |
| ä¿®æ”¹ä¸‹æ‹‰æ¡†é€‰é¡¹ | å½•å…¥é¢æ¿ä¸‹æ‹‰æ¡†åŒæ­¥ | ä¸‹æ‹‰æ¡†ä¸æ›´æ–° | âŒ é€‰é¡¹ä¸ä¸€è‡´ |

### 3.3 PDFé¢„è§ˆè§¦å‘æœºåˆ¶ä¸å¯é 

#### é—®é¢˜è¡¨ç°

```csharp
// PdfPreviewViewModel.cs - ç¬¬88-99è¡Œ
RegisterMessageHandler<Services.Shared.DataChangedMessage>((message) =>
{
    if (message.Key == "DataSaved" || message.Key == "TemplateChanged")
    {
        RefreshPdfPreview().ConfigureAwait(false);
    }
});
```

```csharp
// TemplateEditorViewModel.cs - ç¬¬323-326è¡Œ
[RelayCommand]
private async Task SaveTemplateAsync()
{
    var templateService = new TemplateService();
    await templateService.SaveTemplateAsync(CurrentTemplate);
    // é—®é¢˜ï¼šæ²¡æœ‰å‘é€"TemplateChanged"æ¶ˆæ¯
}
```

#### æ ¹æœ¬åŸå› 

1. **éšå¼ä¾èµ–**ï¼šä¾èµ–"DataSaved"æ¶ˆæ¯è§¦å‘ï¼Œä½†SaveTemplateAsyncä¸å‘é€
2. **æ¶ˆæ¯Keyä¸ç»Ÿä¸€**ï¼šä½¿ç”¨"DataSaved"è€Œä¸æ˜¯"TemplateSaved"
3. **æ— ä¸»åŠ¨åˆ·æ–°æœºåˆ¶**ï¼šç”¨æˆ·æ‰‹åŠ¨ä¿å­˜åæ— æ³•å¼ºåˆ¶åˆ·æ–°PDF

#### å®é™…å½±å“

```mermaid
graph TD
    A[ç”¨æˆ·ä¿å­˜æ¨¡æ¿] --> B{å‘é€æ¶ˆæ¯?}
    B -->|å¦| C[DataSavedæ¶ˆæ¯æœªå‘é€]
    C --> D[PDFä¸åˆ·æ–°]
    D --> E[ç”¨æˆ·å›°æƒ‘ï¼šPDFæ²¡æ›´æ–°]
    
    F[ç”¨æˆ·ä¿å­˜æ•°æ®] --> G{å‘é€æ¶ˆæ¯?}
    G -->|æ˜¯| H[DataSavedæ¶ˆæ¯å‘é€]
    H --> I[PDFåˆ·æ–°]
    I --> J[ä½†æ¨¡æ¿æœªä¿å­˜]
    J --> K[PDFæ˜¾ç¤ºæ—§æ¨¡æ¿æ•°æ®]
```

### 3.4 è¡¨æ ¼å…ƒç´ æ•°æ®æµæ–­è£‚

#### é—®é¢˜è¡¨ç°

```csharp
// Tableå…ƒç´ çš„Valueç±»å‹å¤æ‚
element.Value = new List<TableCell> { ... }

// ä½†DataEntryViewModelæ— æ³•å¤„ç†è¿™ç§å¤æ‚æ•°æ®
[ObservableProperty]
private string _userName; // åªæ”¯æŒç®€å•ç±»å‹
```

#### æ ¹æœ¬åŸå› 

1. **ç±»å‹ä¸åŒ¹é…**ï¼šDataEntryViewModelçš„å±æ€§éƒ½æ˜¯ç®€å•ç±»å‹
2. **æ— è¡¨æ ¼ç¼–è¾‘å™¨**ï¼šç¼ºå°‘ä¸“é—¨çš„è¡¨æ ¼æ•°æ®å½•å…¥ç•Œé¢
3. **æ•°æ®æ˜ å°„ç¼ºå¤±**ï¼šTableçš„å•å…ƒæ ¼å€¼æ— æ³•æ˜ å°„åˆ°å½•å…¥é¢æ¿

#### ä¸šåŠ¡å½±å“

| åŠŸèƒ½ | é¢„æœŸ | å®é™… |
|------|------|------|
| è¡¨æ ¼æ•°æ®å½•å…¥ | ä¸“é—¨çš„è¡¨æ ¼ç¼–è¾‘ç•Œé¢ | âŒ ä¸æ”¯æŒ |
| è¡¨æ ¼æ•°æ®ä¿å­˜ | ä¿å­˜åˆ°æ¨¡æ¿ | âš ï¸ éƒ¨åˆ†æ”¯æŒ |
| è¡¨æ ¼PDFå¯¼å‡º | è¡¨æ ¼å®Œæ•´æ¸²æŸ“ | âœ… æ”¯æŒ |
| è¡¨æ ¼æ•°æ®ç¼–è¾‘ | åœ¨æ•°æ®å½•å…¥é¢æ¿ç¼–è¾‘ | âŒ ä¸æ”¯æŒ |

---

## å››ã€æ”¹è¿›æ–¹æ¡ˆ

### 4.1 æ ¸å¿ƒæ”¹è¿›åŸåˆ™

1. **åŒå‘æ•°æ®ç»‘å®š**ï¼šDataEntry â†” TemplateEditoråŒå‘åŒæ­¥
2. **å…ƒæ•°æ®é©±åŠ¨**ï¼šæ ¹æ®æ¨¡æ¿è‡ªåŠ¨ç”Ÿæˆå½•å…¥å­—æ®µ
3. **è§£è€¦æ¶æ„**ï¼šä½¿ç”¨æ¥å£è€Œéç¡¬ç¼–ç å­—ç¬¦ä¸²
4. **å®Œæ•´æ€§ä¿è¯**ï¼šæ•°æ®æµè½¬é—­ç¯ï¼Œæ— æ–­ç‚¹

### 4.2 æ”¹è¿›æ¶æ„è®¾è®¡

#### æ–°æ¶æ„ï¼šå…ƒæ•°æ®é©±åŠ¨çš„åŒå‘ç»‘å®š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å…ƒæ•°æ®é©±åŠ¨çš„åŒå‘ç»‘å®šç³»ç»Ÿ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ¨¡æ¿å…ƒæ•°æ®è§£æå™¨                             â”‚
â”‚  â€¢ è§£æTemplate.Layout.EditableElements                         â”‚
â”‚  â€¢ ç”Ÿæˆå­—æ®µå®šä¹‰åˆ—è¡¨ (FieldDefinition)                           â”‚
â”‚  â€¢ å»ºç«‹ElementId â†’ FieldKeyæ˜ å°„å…³ç³»                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åŠ¨æ€å­—æ®µå·¥å‚                                 â”‚
â”‚  â€¢ æ ¹æ®FieldDefinitionç”Ÿæˆå½•å…¥å­—æ®µ                               â”‚
â”‚  â€¢ è‡ªåŠ¨é€‰æ‹©æ§ä»¶ç±»å‹ï¼ˆTextBox/ComboBox/DatePickerï¼‰              â”‚
â”‚  â€¢ ç»‘å®šåˆ°DynamicObservableCollection                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åŒå‘åŒæ­¥åè°ƒå™¨                                  â”‚
â”‚  â€¢ DataEntryå˜æ›´ â†’ é€šçŸ¥TemplateEditor                          â”‚
â”‚  â€¢ TemplateEditorå˜æ›´ â†’ é€šçŸ¥DataEntry                          â”‚
â”‚  â€¢ å†²çªæ£€æµ‹ä¸è§£å†³ç­–ç•¥                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®éªŒè¯å±‚                                     â”‚
â”‚  â€¢ å­—æ®µçº§éªŒè¯ï¼ˆå¿…å¡«ã€æ ¼å¼ã€èŒƒå›´ï¼‰                                â”‚
â”‚  â€¢ è·¨å­—æ®µéªŒè¯ï¼ˆä¾èµ–å…³ç³»ã€æ¡ä»¶éªŒè¯ï¼‰                              â”‚
â”‚  â€¢ éªŒè¯ç»“æœç»Ÿä¸€æ”¶é›†ä¸å±•ç¤º                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 å…·ä½“æ”¹è¿›æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šå…ƒæ•°æ®é©±åŠ¨çš„åŠ¨æ€å½•å…¥å­—æ®µ

**ç›®æ ‡**ï¼šæ¶ˆé™¤ç¡¬ç¼–ç ï¼Œæ ¹æ®æ¨¡æ¿è‡ªåŠ¨ç”Ÿæˆå½•å…¥å­—æ®µ

**å®ç°ä»£ç **ï¼š

```csharp
// 1. å­—æ®µå®šä¹‰æ¨¡å‹
public class FieldDefinition
{
    public string ElementId { get; set; }           // å¯¹åº”çš„ElementId
    public string FieldKey { get; set; }           // æ•°æ®Key
    public string DisplayName { get; set; }        // æ˜¾ç¤ºåç§°
    public FieldType Type { get; set; }            // å­—æ®µç±»å‹
    public object DefaultValue { get; set; }        // é»˜è®¤å€¼
    public bool IsRequired { get; set; }          // æ˜¯å¦å¿…å¡«
    public List<string> Options { get; set; }     // ä¸‹æ‹‰é€‰é¡¹
    public string ValidationRegex { get; set; }    // éªŒè¯æ­£åˆ™
    public int? MaxLength { get; set; }           // æœ€å¤§é•¿åº¦
    public DateTime? MinDate { get; set; }         // æœ€å°æ—¥æœŸ
    public DateTime? MaxDate { get; set; }         // æœ€å¤§æ—¥æœŸ
}

public enum FieldType
{
    TextBox,
    ComboBox,
    DatePicker,
    CheckBox,
    Table,
    Image
}

// 2. å­—æ®µè§£ææœåŠ¡
public class FieldParserService
{
    public List<FieldDefinition> ParseFromTemplate(TemplateData template)
    {
        var definitions = new List<FieldDefinition>();

        foreach (var element in template.Layout.EditableElements)
        {
            var definition = new FieldDefinition
            {
                ElementId = element.ElementId,
                FieldKey = element.ElementId, // ä½¿ç”¨ElementIdä½œä¸ºFieldKey
                DisplayName = element.DisplayName ?? element.ElementId,
                Type = MapToFieldType(element.Type),
                DefaultValue = element.Value,
                IsRequired = element.GetProperty<bool>("IsRequired", false),
                Options = ParseDropdownOptions(element),
                ValidationRegex = element.GetProperty<string>("ValidationRegex"),
                MaxLength = element.GetProperty<int?>("MaxLength"),
                MinDate = element.GetProperty<DateTime?>("MinDate"),
                MaxDate = element.GetProperty<DateTime?>("MaxDate")
            };

            definitions.Add(definition);
        }

        return definitions;
    }

    private FieldType MapToFieldType(ControlType controlType)
    {
        return controlType switch
        {
            ControlType.TextBox => FieldType.TextBox,
            ControlType.ComboBox => FieldType.ComboBox,
            ControlType.DatePicker => FieldType.DatePicker,
            ControlType.CheckBox => FieldType.CheckBox,
            ControlType.Table => FieldType.Table,
            ControlType.Image => FieldType.Image,
            _ => FieldType.TextBox
        };
    }

    private List<string> ParseDropdownOptions(ControlElement element)
    {
        if (element.Type != ControlType.ComboBox)
            return null;

        var optionsText = element.GetProperty<string>("Options", "");
        return optionsText
            .Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries)
            .Select(line => line.Trim())
            .Where(line => !string.IsNullOrEmpty(line))
            .ToList();
    }
}

// 3. æ–°çš„DataEntryViewModelï¼ˆåŠ¨æ€ç‰ˆæœ¬ï¼‰
public partial class DynamicDataEntryViewModel : ViewModelBase
{
    private readonly ISharedDataService _sharedDataService;
    private readonly FieldParserService _fieldParser;

    [ObservableProperty]
    private ObservableCollection<FieldDefinition> _fieldDefinitions;

    [ObservableProperty]
    private ObservableDictionary<string, object> _fieldValues;

    public DynamicDataEntryViewModel()
    {
        _sharedDataService = SharedDataService.Instance;
        _fieldParser = new FieldParserService();
        _fieldDefinitions = new ObservableCollection<FieldDefinition>();
        _fieldValues = new ObservableDictionary<string, object>();

        RegisterMessageHandlers();
        LoadTemplateFields();
    }

    private void RegisterMessageHandlers()
    {
        // ç›‘å¬æ¨¡æ¿åŠ è½½æ¶ˆæ¯
        RegisterMessageHandler<TemplateLoadedMessage>(message =>
        {
            LoadTemplateFields();
        });

        // ç›‘å¬æ•°æ®å˜æ›´
        RegisterMessageHandler<DataChangedMessage>(message =>
        {
            HandleDataChange(message.Key, message.Value);
        });
    }

    private void LoadTemplateFields()
    {
        var template = _sharedDataService.CurrentTemplate;
        if (template == null) return;

        // è§£ææ¨¡æ¿å­—æ®µ
        var definitions = _fieldParser.ParseFromTemplate(template);
        
        // æ›´æ–°å­—æ®µå®šä¹‰
        _fieldDefinitions.Clear();
        foreach (var def in definitions)
        {
            _fieldDefinitions.Add(def);
            
            // åˆå§‹åŒ–å­—æ®µå€¼
            if (!_fieldValues.ContainsKey(def.FieldKey))
            {
                _fieldValues[def.FieldKey] = def.DefaultValue ?? 
                    (def.Type == FieldType.ComboBox ? 
                        (def.Options?.FirstOrDefault()) : null);
            }
        }

        // å‘é€å­—æ®µåŠ è½½å®Œæˆæ¶ˆæ¯
        _sharedDataService.BroadcastDataChange("FieldsLoaded", _fieldValues);
    }

    // å­—æ®µå€¼å˜æ›´æ—¶è‡ªåŠ¨åŒæ­¥
    partial void OnFieldValuesChanged()
    {
        // åŒæ­¥åˆ°SharedDataService
        foreach (var kvp in _fieldValues)
        {
            _sharedDataService.UpdateUserData(kvp.Key, kvp.Value);
        }

        // é€šçŸ¥TemplateEditoræ›´æ–°
        _sharedDataService.BroadcastDataChange("FieldValuesChanged", _fieldValues);
    }

    private void HandleDataChange(string key, object value)
    {
        // ä»TemplateEditoræˆ–å…¶ä»–æ¥æºæ¥æ”¶æ›´æ–°
        if (_fieldValues.ContainsKey(key))
        {
            _fieldValues[key] = value;
        }
    }

    [RelayCommand]
    private async Task SaveDataAsync()
    {
        if (ValidateFields())
        {
            try
            {
                // ä¿å­˜æ•°æ®é€»è¾‘
                await Task.CompletedTask;
                
                // é€šçŸ¥PDFé¢„è§ˆåˆ·æ–°
                _sharedDataService.BroadcastDataChange("PdfRefresh", true);
            }
            catch (Exception ex)
            {
                _sharedDataService.BroadcastDataChange("Error", ex.Message);
            }
        }
    }

    private bool ValidateFields()
    {
        var errors = new List<string>();

        foreach (var field in _fieldDefinitions)
        {
            var value = _fieldValues.GetValueOrDefault(field.FieldKey);

            // éªŒè¯å¿…å¡«
            if (field.IsRequired && (value == null || string.IsNullOrEmpty(value.ToString())))
            {
                errors.Add($"{field.DisplayName}ä¸èƒ½ä¸ºç©º");
                continue;
            }

            // éªŒè¯æ­£åˆ™
            if (!string.IsNullOrEmpty(field.ValidationRegex) && 
                value != null && 
                !string.IsNullOrEmpty(value.ToString()))
            {
                var regex = new Regex(field.ValidationRegex);
                if (!regex.IsMatch(value.ToString()))
                {
                    errors.Add($"{field.DisplayName}æ ¼å¼ä¸æ­£ç¡®");
                }
            }

            // éªŒè¯å­—ç¬¦ä¸²é•¿åº¦
            if (field.MaxLength.HasValue && 
                value != null && 
                value.ToString().Length > field.MaxLength.Value)
            {
                errors.Add($"{field.DisplayName}é•¿åº¦ä¸èƒ½è¶…è¿‡{field.MaxLength.Value}ä¸ªå­—ç¬¦");
            }

            // éªŒè¯æ—¥æœŸèŒƒå›´
            if (field.Type == FieldType.DatePicker && value is DateTime dateValue)
            {
                if (field.MinDate.HasValue && dateValue < field.MinDate.Value)
                {
                    errors.Add($"{field.DisplayName}ä¸èƒ½æ—©äº{field.MinDate.Value:yyyy-MM-dd}");
                }

                if (field.MaxDate.HasValue && dateValue > field.MaxDate.Value)
                {
                    errors.Add($"{field.DisplayName}ä¸èƒ½æ™šäº{field.MaxDate.Value:yyyy-MM-dd}");
                }
            }
        }

        if (errors.Any())
        {
            ErrorMessage = string.Join("\n", errors);
            return false;
        }

        ErrorMessage = string.Empty;
        return true;
    }
}
```

**XAMLåŠ¨æ€æ¸²æŸ“**ï¼š

```xaml
<UserControl x:Class="DynamicDataEntryView">
    <ScrollViewer>
        <ItemsControl ItemsSource="{Binding FieldDefinitions}">
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <Grid Margin="0,0,0,10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- å­—æ®µæ ‡ç­¾ -->
                        <TextBlock Grid.Row="0" Text="{Binding DisplayName}"/>
                        <TextBlock Grid.Row="0" 
                                   Text=" *" 
                                   Foreground="Red"
                                   Visibility="{Binding IsRequired, 
                                     Converter={StaticResource BoolToVisibilityConverter}}"/>

                        <!-- æ ¹æ®å­—æ®µç±»å‹åŠ¨æ€ç”Ÿæˆæ§ä»¶ -->
                        <ContentControl Grid.Row="1">
                            <ContentControl.Style>
                                <Style TargetType="ContentControl">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Type}" Value="TextBox">
                                            <Setter Property="ContentTemplate">
                                                <Setter.Value>
                                                    <DataTemplate>
                                                        <TextBox Text="{Binding Path=DataContext.FieldValues[FieldKey], 
                                                                         Mode=TwoWorld, 
                                                                         UpdateSourceTrigger=PropertyChanged}"
                                                                 MaxLength="{Binding MaxLength}"/>
                                                    </DataTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Type}" Value="ComboBox">
                                            <Setter Property="ContentTemplate">
                                                <Setter.Value>
                                                    <DataTemplate>
                                                        <ComboBox ItemsSource="{Binding Options}"
                                                                  SelectedItem="{Binding Path=DataContext.FieldValues[FieldKey], Mode=TwoWorld}"/>
                                                    </DataTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Type}" Value="DatePicker">
                                            <Setter Property="ContentTemplate">
                                                <Setter.Value>
                                                    <DataTemplate>
                                                        <DatePicker SelectedDate="{Binding Path=DataContext.FieldValues[FieldKey], Mode=TwoWorld}"
                                                                    DisplayDateStart="{Binding MinDate}"
                                                                    DisplayDateEnd="{Binding MaxDate}"/>
                                                    </DataTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Type}" Value="CheckBox">
                                            <Setter Property="ContentTemplate">
                                                <Setter.Value>
                                                    <DataTemplate>
                                                        <CheckBox IsChecked="{Binding Path=DataContext.FieldValues[FieldKey], Mode=TwoWorld}"
                                                                  Content="{Binding DisplayName}"/>
                                                    </DataTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ContentControl.Style>
                        </ContentControl>
                    </Grid>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
    </ScrollViewer>
</UserControl>
```

#### æ–¹æ¡ˆ2ï¼šåŒå‘åŒæ­¥åè°ƒå™¨

**ç›®æ ‡**ï¼šå®ç°DataEntry â†” TemplateEditorçš„åŒå‘å®æ—¶åŒæ­¥

**å®ç°ä»£ç **ï¼š

```csharp
// åŒå‘åŒæ­¥åè°ƒå™¨
public class BidirectionalSyncCoordinator
{
    private readonly ISharedDataService _sharedDataService;
    private readonly object _syncLock = new();
    private bool _isUpdatingFromDataEntry = false;
    private bool _isUpdatingFromTemplateEditor = false;

    public BidirectionalSyncCoordinator(ISharedDataService sharedDataService)
    {
        _sharedDataService = sharedDataService;
        RegisterHandlers();
    }

    private void RegisterHandlers()
    {
        // DataEntry â†’ TemplateEditor
        _sharedDataService.RegisterMessageHandler<FieldValuesChangedMessage>(message =>
        {
            if (_isUpdatingFromTemplateEditor) return;

            lock (_syncLock)
            {
                _isUpdatingFromDataEntry = true;
                try
                {
                    SyncToTemplateEditor(message.FieldValues);
                }
                finally
                {
                    _isUpdatingFromDataEntry = false;
                }
            }
        });

        // TemplateEditor â†’ DataEntry
        _sharedDataService.RegisterMessageHandler<ElementValueChangedMessage>(message =>
        {
            if (_isUpdatingFromDataEntry) return;

            lock (_syncLock)
            {
                _isUpdatingFromTemplateEditor = true;
                try
                {
                    SyncToDataEntry(message.ElementId, message.NewValue);
                }
                finally
                {
                    _isUpdatingFromTemplateEditor = false;
                }
            }
        });
    }

    private void SyncToTemplateEditor(ObservableDictionary<string, object> fieldValues)
    {
        var template = _sharedDataService.CurrentTemplate;
        if (template == null) return;

        foreach (var kvp in fieldValues)
        {
            var element = template.Layout.EditableElements
                .FirstOrDefault(e => e.ElementId == kvp.Key);

            if (element != null)
            {
                // æ›´æ–°å…ƒç´ å€¼
                element.Value = kvp.Value;

                // è®°å½•åˆ°å‘½ä»¤å†å²ï¼ˆå¦‚æœéœ€è¦ï¼‰
                // Note: è¿™é‡Œéœ€è¦è€ƒè™‘æ˜¯å¦è®°å½•åˆ°CommandHistory
            }
        }

        // é€šçŸ¥UIåˆ·æ–°
        _sharedDataService.BroadcastDataChange("TemplateElementsUpdated", true);
    }

    private void SyncToDataEntry(string elementId, object value)
    {
        // æ›´æ–°DataEntryçš„å­—æ®µå€¼
        _sharedDataService.UpdateUserData(elementId, value);
    }
}

// æ–°çš„æ¶ˆæ¯ç±»å‹
public record FieldValuesChangedMessage(ObservableDictionary<string, object> FieldValues);

public record ElementValueChangedMessage(string ElementId, object NewValue, object OldValue);
```

**TemplateEditorViewModelé›†æˆ**ï¼š

```csharp
public partial class TemplateEditorViewModel : ViewModelBase
{
    private readonly BidirectionalSyncCoordinator _syncCoordinator;

    public TemplateEditorViewModel()
    {
        _sharedDataService = SharedDataService.Instance;
        _commandHistory = new CommandHistory();
        _syncCoordinator = new BidirectionalSyncCoordinator(_sharedDataService);

        // ... ç°æœ‰ä»£ç  ...
    }

    [RelayCommand]
    private void SetDefaultValue(ControlElement element)
    {
        var window = new Window { /* ... */ };
        
        if (window.ShowDialog() == true)
        {
            var oldValue = element.Value;
            var newValue = textBox.Text;
            
            // æ›´æ–°å…ƒç´ å€¼
            element.Value = newValue;
            
            // è®°å½•åˆ°å‘½ä»¤å†å²
            var command = new ChangeControlPropertyCommand(
                element, "Value", oldValue, newValue);
            _commandHistory.ExecuteCommand(command);
            
            // ğŸ”¥ æ–°å¢ï¼šé€šçŸ¥DataEntryæ›´æ–°
            _sharedDataService.SendMessage(new ElementValueChangedMessage(
                element.ElementId, newValue, oldValue));
        }
    }

    [RelayCommand]
    private async Task LoadTemplateAsync(string templateId)
    {
        var templateService = new TemplateService();
        CurrentTemplate = await templateService.GetTemplateByIdAsync(templateId);

        // æ›´æ–°ç”»å¸ƒå°ºå¯¸
        PaperWidth = CurrentTemplate.Layout.PaperWidth;
        PaperHeight = CurrentTemplate.Layout.PaperHeight;

        // ğŸ”¥ æ–°å¢ï¼šé€šçŸ¥DataEntryåŠ è½½æ–°æ¨¡æ¿å­—æ®µ
        _sharedDataService.SendMessage(new TemplateLoadedMessage(templateId));

        // ğŸ”¥ æ–°å¢ï¼šé€šçŸ¥PDFé¢„è§ˆåˆ·æ–°
        _sharedDataService.BroadcastDataChange("TemplateChanged", templateId);
    }
}

// æ–°å¢æ¶ˆæ¯ç±»å‹
public record TemplateLoadedMessage(string TemplateId);
```

#### æ–¹æ¡ˆ3ï¼šPDFé¢„è§ˆåˆ·æ–°æœºåˆ¶æ”¹è¿›

**ç›®æ ‡**ï¼šå»ºç«‹å¯é ã€ä¸»åŠ¨çš„PDFåˆ·æ–°æœºåˆ¶

**å®ç°ä»£ç **ï¼š

```csharp
// PdfPreviewViewModelæ”¹è¿›
public partial class PdfPreviewViewModel : ViewModelBase
{
    private Timer _autoRefreshTimer;
    private bool _isRefreshing = false;

    public PdfPreviewViewModel()
    {
        _sharedDataService = ServiceLocator.Instance.GetService<ISharedDataService>();
        _pdfService = ServiceLocator.Instance.GetService<IPdfService>();
        
        InitializeWebView();
        InitializeCollections();
        RegisterDataChangeHandlers();
        
        // ğŸ”¥ æ–°å¢ï¼šå¯åŠ¨è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨ï¼ˆé˜²æŠ–ï¼‰
        _autoRefreshTimer = new Timer(OnAutoRefresh, null, Timeout.Infinite, Timeout.Infinite);
    }

    private void RegisterDataChangeHandlers()
    {
        // ç›‘å¬æ•°æ®å˜æ›´
        RegisterMessageHandler<DataChangedMessage>(message =>
        {
            if (message.Key == "DataSaved" || 
                message.Key == "TemplateChanged" ||
                message.Key == "FieldValuesChanged" ||
                message.Key == "PdfRefresh")
            {
                SchedulePdfRefresh(delayMs: 500);
            }
        });

        // ğŸ”¥ æ–°å¢ï¼šç›‘å¬æ¨¡æ¿åŠ è½½æ¶ˆæ¯
        RegisterMessageHandler<TemplateLoadedMessage>(message =>
        {
            SchedulePdfRefresh(delayMs: 1000);
        });

        // ğŸ”¥ æ–°å¢ï¼šç›‘å¬æ¨¡æ¿å…ƒç´ æ›´æ–°æ¶ˆæ¯
        RegisterMessageHandler<DataChangedMessage>(message =>
        {
            if (message.Key == "TemplateElementsUpdated")
            {
                SchedulePdfRefresh(delayMs: 300);
            }
        });
    }

    // ğŸ”¥ æ–°å¢ï¼šé˜²æŠ–åˆ·æ–°æœºåˆ¶
    private void SchedulePdfRefresh(int delayMs)
    {
        if (_isRefreshing) return;

        _autoRefreshTimer.Change(delayMs, Timeout.Infinite);
    }

    private void OnAutoRefresh(object state)
    {
        _isRefreshing = true;
        
        Application.Current.Dispatcher.InvokeAsync(async () =>
        {
            try
            {
                await RefreshPdfPreview();
            }
            finally
            {
                _isRefreshing = false;
            }
        });
    }

    [RelayCommand]
    private async Task RefreshPdfAsync()
    {
        await RefreshPdfPreview();
    }

    private async Task RefreshPdfPreview()
    {
        if (_sharedDataService.CurrentTemplate == null)
            return;

        try
        {
            var options = new PdfExportOptions
            {
                PaperSize = SelectedPaperSize,
                Orientation = SelectedOrientation,
                HeaderText = HeaderText,
                FooterText = FooterText
            };

            var pdfFilePath = await _pdfService.GeneratePdfAsync(
                _sharedDataService.UserData, 
                _sharedDataService.CurrentTemplate.TemplateId, 
                options);

            await LoadPdfAsync(pdfFilePath);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"ç”ŸæˆPDFå¤±è´¥: {ex.Message}";
        }
    }

    // ğŸ”¥ æ–°å¢ï¼šå¼ºåˆ¶åˆ·æ–°å‘½ä»¤
    [RelayCommand]
    private async Task ForceRefreshPdfAsync()
    {
        // å–æ¶ˆå¾…åˆ·æ–°ä»»åŠ¡
        _autoRefreshTimer.Change(Timeout.Infinite, Timeout.Infinite);
        
        // ç«‹å³åˆ·æ–°
        _isRefreshing = false;
        await RefreshPdfPreview();
    }
}
```

#### æ–¹æ¡ˆ4ï¼šè¡¨æ ¼å…ƒç´ æ•°æ®æµä¿®å¤

**ç›®æ ‡**ï¼šä¸ºTableå…ƒç´ æä¾›å®Œæ•´çš„æ•°æ®å½•å…¥å’ŒåŒæ­¥æœºåˆ¶

**å®ç°ä»£ç **ï¼š

```csharp
// è¡¨æ ¼æ•°æ®æ¨¡å‹
public class TableCellData : ObservableObject
{
    [ObservableProperty]
    private int _rowIndex;

    [ObservableProperty]
    private int _columnIndex;

    [ObservableProperty]
    private string _columnId;

    [ObservableProperty]
    private string _value;

    [ObservableProperty]
    private List<string> _options;

    [ObservableProperty]
    private CellControlType _controlType;

    [ObservableProperty]
    private bool _isReadOnly;
}

public class TableData : ObservableObject
{
    [ObservableProperty]
    private string _tableElementId;

    [ObservableProperty]
    private List<ColumnConfig> _columns;

    [ObservableProperty]
    private ObservableCollection<ObservableCollection<TableCellData>> _rows;

    [ObservableProperty]
    private bool _allowAddRow;

    [ObservableProperty]
    private bool _allowDeleteRow;

    public TableData(ControlElement tableElement)
    {
        TableElementId = tableElement.ElementId;
        
        var config = tableElement.GetProperty<TableConfig>("TableConfig", new TableConfig());
        Columns = config.Columns;
        AllowAddRow = config.AllowAddRow;
        AllowDeleteRow = config.AllowDeleteRow;

        Rows = new ObservableCollection<ObservableCollection<TableCellData>>();
        
        // åˆå§‹åŒ–é»˜è®¤è¡Œ
        for (int i = 0; i < config.DefaultRowCount; i++)
        {
            AddRow();
        }
    }

    public ObservableCollection<TableCellData> AddRow()
    {
        var newRow = new ObservableCollection<TableCellData>();
        
        foreach (var column in Columns)
        {
            newRow.Add(new TableCellData
            {
                RowIndex = Rows.Count,
                ColumnIndex = column.ColumnId.GetHashCode(), // ä¸´æ—¶ID
                ColumnId = column.ColumnId,
                Value = GetDefaultValue(column),
                Options = column.DropdownOptions,
                ControlType = column.ControlType,
                IsReadOnly = column.IsReadOnly
            });
        }

        Rows.Add(newRow);
        
        // æ›´æ–°è¡Œç´¢å¼•
        UpdateRowIndices();
        
        return newRow;
    }

    public void RemoveRow(ObservableCollection<TableCellData> row)
    {
        Rows.Remove(row);
        UpdateRowIndices();
    }

    private void UpdateRowIndices()
    {
        for (int i = 0; i < Rows.Count; i++)
        {
            foreach (var cell in Rows[i])
            {
                cell.RowIndex = i;
            }
        }
    }

    private string GetDefaultValue(ColumnConfig column)
    {
        return column.ControlType switch
        {
            CellControlType.ComboBox => column.DropdownOptions?.FirstOrDefault(),
            _ => string.Empty
        };
    }
}

// DynamicDataEntryViewModelä¸­æ·»åŠ è¡¨æ ¼æ”¯æŒ
public partial class DynamicDataEntryViewModel : ViewModelBase
{
    [ObservableProperty]
    private Dictionary<string, TableData> _tableData = new();

    private void LoadTemplateFields()
    {
        var template = _sharedDataService.CurrentTemplate;
        if (template == null) return;

        var definitions = _fieldParser.ParseFromTemplate(template);
        
        _fieldDefinitions.Clear();
        
        // å¤„ç†æ™®é€šå­—æ®µ
        foreach (var def in definitions.Where(d => d.Type != FieldType.Table))
        {
            _fieldDefinitions.Add(def);
            
            if (!_fieldValues.ContainsKey(def.FieldKey))
            {
                _fieldValues[def.FieldKey] = def.DefaultValue ?? 
                    (def.Type == FieldType.ComboBox ? 
                        (def.Options?.FirstOrDefault()) : null);
            }
        }

        // ğŸ”¥ æ–°å¢ï¼šå¤„ç†è¡¨æ ¼å­—æ®µ
        foreach (var tableElement in template.Layout.EditableElements
            .Where(e => e.Type == ControlType.Table))
        {
            var tableData = new TableData(tableElement);
            _tableData[tableElement.ElementId] = tableData;
        }

        // å‘é€åŠ è½½å®Œæˆæ¶ˆæ¯
        _sharedDataService.BroadcastDataChange("FieldsLoaded", _fieldValues);
        _sharedDataService.BroadcastDataChange("TablesLoaded", _tableData);
    }

    // è¡¨æ ¼æ•°æ®å˜æ›´æ—¶åŒæ­¥åˆ°æ¨¡æ¿
    partial void OnTableDataChanged()
    {
        var template = _sharedDataService.CurrentTemplate;
        if (template == null) return;

        foreach (var kvp in _tableData)
        {
            var tableElement = template.Layout.EditableElements
                .FirstOrDefault(e => e.ElementId == kvp.Key);

            if (tableElement != null)
            {
                var tableData = kvp.Value;
                var tableConfig = tableElement.GetProperty<TableConfig>("TableConfig");

                // æ›´æ–°è¡¨æ ¼é…ç½®
                if (tableConfig == null)
                {
                    tableConfig = new TableConfig();
                }

                // ğŸ”¥ è½¬æ¢TableDataä¸ºå¯åºåˆ—åŒ–çš„æ ¼å¼
                var rows = tableData.Rows.Select(row => 
                    row.Select(cell => new
                    {
                        ColumnId = cell.ColumnId,
                        Value = cell.Value
                    }).ToList()
                ).ToList();

                tableElement.Value = rows;
                tableElement.SetProperty("TableData", tableData);
            }
        }

        // é€šçŸ¥PDFåˆ·æ–°
        _sharedDataService.BroadcastDataChange("PdfRefresh", true);
    }
}
```

**è¡¨æ ¼ç¼–è¾‘ç•Œé¢**ï¼š

```xaml
<UserControl x:Class="TableEditView">
    <DataGrid ItemsSource="{Binding Rows}"
              AutoGenerateColumns="False"
              CanUserAddRows="{Binding AllowAddRow}"
              CanUserDeleteRows="{Binding AllowDeleteRow}">
        <DataGrid.Columns>
            <!-- åŠ¨æ€ç”Ÿæˆåˆ— -->
            <ItemsControl ItemsSource="{Binding Columns}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <DataGridTemplateColumn 
                            Width="{Binding Width}" 
                            Header="{Binding HeaderText}">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ContentControl>
                                        <ContentControl.ContentTemplateSelector>
                                            <local:CellTemplateSelector>
                                                <local:CellTemplateSelector.TextBoxTemplate>
                                                    <DataTemplate>
                                                        <TextBox Text="{Binding Value, Mode=TwoWorld}"/>
                                                    </DataTemplate>
                                                </local:CellTemplateSelector.TextBoxTemplate>
                                                <local:CellTemplateSelector.ComboBoxTemplate>
                                                    <DataTemplate>
                                                        <ComboBox ItemsSource="{Binding Options}"
                                                                  SelectedItem="{Binding Value, Mode=TwoWorld}"/>
                                                    </DataTemplate>
                                                </local:CellTemplateSelector.ComboBoxTemplate>
                                            </local:CellTemplateSelector>
                                        </ContentControl.ContentTemplateSelector>
                                    </ContentControl>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </DataGrid.Columns>
    </DataGrid>
</UserControl>
```

---

## äº”ã€å®æ–½è·¯çº¿å›¾

### 5.1 é˜¶æ®µä¸€ï¼šå…ƒæ•°æ®é©±åŠ¨ï¼ˆä¼˜å…ˆçº§ï¼šğŸ”´ é«˜ï¼‰

**ç›®æ ‡**ï¼šæ¶ˆé™¤ç¡¬ç¼–ç ï¼Œå®ç°åŠ¨æ€å­—æ®µç”Ÿæˆ

| ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | è´Ÿè´£äºº | ä¾èµ– |
|------|---------|--------|------|
| åˆ›å»ºFieldDefinitionæ¨¡å‹ | 2å°æ—¶ | åç«¯ | æ—  |
| å®ç°FieldParserService | 4å°æ—¶ | åç«¯ | æ—  |
| é‡æ„DataEntryViewModelä¸ºDynamicDataEntryViewModel | 8å°æ—¶ | å‰ç«¯ | 1,2 |
| å®ç°åŠ¨æ€å­—æ®µXAMLæ¸²æŸ“ | 6å°æ—¶ | å‰ç«¯ | 3 |
| å•å…ƒæµ‹è¯• | 4å°æ—¶ | æµ‹è¯• | 1-4 |
| **å°è®¡** | **24å°æ—¶** | - | - |

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] åŠ è½½ä»»æ„æ¨¡æ¿åï¼Œå½•å…¥é¢æ¿è‡ªåŠ¨æ˜¾ç¤ºæ‰€æœ‰å¯ç¼–è¾‘å­—æ®µ
- [ ] ä¿®æ”¹æ¨¡æ¿åï¼Œå½•å…¥é¢æ¿å­—æ®µè‡ªåŠ¨æ›´æ–°
- [ ] å­—æ®µç±»å‹æ­£ç¡®æ˜ å°„ï¼ˆTextBox/ComboBox/DatePickerç­‰ï¼‰

### 5.2 é˜¶æ®µäºŒï¼šåŒå‘åŒæ­¥ï¼ˆä¼˜å…ˆçº§ï¼šğŸ”´ é«˜ï¼‰

**ç›®æ ‡**ï¼šå®ç°DataEntry â†” TemplateEditoråŒå‘åŒæ­¥

| ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | è´Ÿè´£äºº | ä¾èµ– |
|------|---------|--------|------|
| åˆ›å»ºBidirectionalSyncCoordinator | 6å°æ—¶ | åç«¯ | é˜¶æ®µä¸€ |
| ä¿®æ”¹TemplateEditorViewModelå‘é€åŒæ­¥æ¶ˆæ¯ | 4å°æ—¶ | å‰ç«¯ | 1 |
| ä¿®æ”¹SetDefaultValue/LoadTemplateAsyncæ–¹æ³• | 3å°æ—¶ | å‰ç«¯ | 1,2 |
| å®ç°é˜²æŠ–æœºåˆ¶ | 2å°æ—¶ | åç«¯ | æ—  |
| é›†æˆæµ‹è¯• | 4å°æ—¶ | æµ‹è¯• | 1-4 |
| **å°è®¡** | **19å°æ—¶** | - | é˜¶æ®µä¸€ |

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] åœ¨å½•å…¥é¢æ¿ä¿®æ”¹å€¼ï¼Œç”»å¸ƒæ§ä»¶å€¼åŒæ­¥æ›´æ–°
- [ ] åœ¨ç”»å¸ƒä¿®æ”¹é»˜è®¤å€¼ï¼Œå½•å…¥é¢æ¿å­—æ®µå€¼åŒæ­¥æ›´æ–°
- [ ] åŠ è½½æ–°æ¨¡æ¿åï¼Œå½•å…¥é¢æ¿å­—æ®µå€¼æ­£ç¡®åˆå§‹åŒ–

### 5.3 é˜¶æ®µä¸‰ï¼šPDFåˆ·æ–°æ”¹è¿›ï¼ˆä¼˜å…ˆçº§ï¼šğŸŸ¡ ä¸­ï¼‰

**ç›®æ ‡**ï¼šå»ºç«‹å¯é çš„PDFåˆ·æ–°æœºåˆ¶

| ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | è´Ÿè´£äºº | ä¾èµ– |
|------|---------|--------|------|
| å®ç°é˜²æŠ–åˆ·æ–°æœºåˆ¶ | 3å°æ—¶ | å‰ç«¯ | æ—  |
| ä¿®æ”¹PdfPreviewViewModelç›‘å¬æ–°æ¶ˆæ¯ | 2å°æ—¶ | å‰ç«¯ | æ—  |
| æ·»åŠ å¼ºåˆ¶åˆ·æ–°å‘½ä»¤ | 1å°æ—¶ | å‰ç«¯ | æ—  |
| é›†æˆæµ‹è¯• | 2å°æ—¶ | æµ‹è¯• | 1-3 |
| **å°è®¡** | **8å°æ—¶** | - | æ—  |

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] ä¿å­˜æ•°æ®åï¼ŒPDFè‡ªåŠ¨åˆ·æ–°ï¼ˆ500mså»¶è¿Ÿï¼‰
- [ ] ä¿®æ”¹æ¨¡æ¿åï¼ŒPDFè‡ªåŠ¨åˆ·æ–°ï¼ˆ1så»¶è¿Ÿï¼‰
- [ ] ç‚¹å‡»å¼ºåˆ¶åˆ·æ–°æŒ‰é’®ï¼Œç«‹å³åˆ·æ–°PDF

### 5.4 é˜¶æ®µå››ï¼šè¡¨æ ¼æ•°æ®æµä¿®å¤ï¼ˆä¼˜å…ˆçº§ï¼šğŸ”´ é«˜ï¼‰

**ç›®æ ‡**ï¼šä¸ºTableå…ƒç´ æä¾›å®Œæ•´æ•°æ®å½•å…¥æ”¯æŒ

| ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | è´Ÿè´£äºº | ä¾èµ– |
|------|---------|--------|------|
| åˆ›å»ºTableDataå’ŒTableCellDataæ¨¡å‹ | 4å°æ—¶ | åç«¯ | æ—  |
| å®ç°TableDataçš„AddRow/RemoveRow | 4å°æ—¶ | åç«¯ | 1 |
| å®ç°TableEditViewç•Œé¢ | 8å°æ—¶ | å‰ç«¯ | 1,2 |
| é›†æˆåˆ°DynamicDataEntryViewModel | 4å°æ—¶ | å‰ç«¯ | 1-3 |
| å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯• | 4å°æ—¶ | æµ‹è¯• | 1-4 |
| **å°è®¡** | **24å°æ—¶** | - | æ—  |

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] å½•å…¥é¢æ¿æ˜¾ç¤ºè¡¨æ ¼ç¼–è¾‘å™¨
- [ ] æ”¯æŒæ·»åŠ /åˆ é™¤è¡Œ
- [ ] æ”¯æŒç¼–è¾‘å•å…ƒæ ¼å€¼
- [ ] ä¸‹æ‹‰æ¡†å•å…ƒæ ¼æ­£å¸¸å·¥ä½œ
- [ ] è¡¨æ ¼æ•°æ®æ­£ç¡®åŒæ­¥åˆ°æ¨¡æ¿å’ŒPDF

### 5.5 é˜¶æ®µäº”ï¼šé«˜çº§ç‰¹æ€§ï¼ˆä¼˜å…ˆçº§ï¼šğŸŸ¢ ä½ï¼‰

**ç›®æ ‡**ï¼šå®ç°å…ƒç´ è”åŠ¨ã€æ¡ä»¶æ˜¾ç¤ºç­‰é«˜çº§åŠŸèƒ½

| ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | è´Ÿè´£äºº | ä¾èµ– |
|------|---------|--------|------|
| è®¾è®¡å…ƒç´ äº‹ä»¶ç³»ç»Ÿ | 4å°æ—¶ | æ¶æ„ | æ—  |
| å®ç°å…ƒç´ è”åŠ¨æœºåˆ¶ | 8å°æ—¶ | åç«¯ | 1 |
| å®ç°æ¡ä»¶æ˜¾ç¤ºè§„åˆ™ | 6å°æ—¶ | å‰ç«¯ | 1,2 |
| å®ç°é«˜çº§éªŒè¯è§„åˆ™ | 6å°æ—¶ | åç«¯ | 1 |
| é›†æˆæµ‹è¯• | 4å°æ—¶ | æµ‹è¯• | 1-4 |
| **å°è®¡** | **28å°æ—¶** | - | æ—  |

---

## å…­ã€æ€»ç»“

### 6.1 é—®é¢˜æ±‡æ€»

| é—®é¢˜ç±»åˆ« | å…·ä½“é—®é¢˜ | å½±å“ | ä¼˜å…ˆçº§ |
|---------|---------|------|--------|
| **æ•°æ®ç»‘å®š** | ç¡¬ç¼–ç å­—ç¬¦ä¸²Key | ç»´æŠ¤æˆæœ¬é«˜ï¼Œæ˜“å‡ºé”™ | ğŸ”´ é«˜ |
| **æ•°æ®åŒæ­¥** | å•å‘åŒæ­¥ï¼Œç¼ºå¤±åå‘åŒæ­¥ | ç”¨æˆ·æ“ä½œä½“éªŒå·® | ğŸ”´ é«˜ |
| **PDFåˆ·æ–°** | è§¦å‘æœºåˆ¶ä¸å¯é  | é¢„è§ˆä¸åŒæ­¥ | ğŸŸ¡ ä¸­ |
| **è¡¨æ ¼æ”¯æŒ** | æ•°æ®æµæ–­è£‚ | è¡¨æ ¼åŠŸèƒ½ä¸å®Œæ•´ | ğŸ”´ é«˜ |
| **æ‰©å±•æ€§** | ç¼ºå°‘åŠ¨æ€å­—æ®µç”Ÿæˆ | æ–°å¢å­—æ®µéœ€ä¿®æ”¹ä»£ç  | ğŸ”´ é«˜ |

### 6.2 æ”¹è¿›æ•ˆæœé¢„æœŸ

| ç»´åº¦ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡å¹…åº¦ |
|------|-------|--------|---------|
| æ•°æ®ç»‘å®š | ç¡¬ç¼–ç ï¼Œæ˜“é”™ | å…ƒæ•°æ®é©±åŠ¨ï¼Œè‡ªåŠ¨æ˜ å°„ | âœ… 90% â†’ 100% |
| æ•°æ®åŒæ­¥ | å•å‘ï¼Œä¸å®Œæ•´ | åŒå‘ï¼Œå®æ—¶åŒæ­¥ | âœ… 50% â†’ 95% |
| PDFåˆ·æ–° | ä¸å¯é  | é˜²æŠ–+ä¸»åŠ¨åˆ·æ–° | âœ… 60% â†’ 90% |
| è¡¨æ ¼æ”¯æŒ | ä¸æ”¯æŒ | å®Œæ•´æ”¯æŒ | âœ… 0% â†’ 85% |
| ç»´æŠ¤æˆæœ¬ | é«˜ï¼ˆ3å¤„ä¿®æ”¹ï¼‰ | ä½ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ | âœ… é™ä½70% |
| ç”¨æˆ·ä½“éªŒ | å·®ï¼ˆæ•°æ®ä¸åŒæ­¥ï¼‰ | å¥½ï¼ˆå®æ—¶åŒæ­¥ï¼‰ | âœ… æå‡80% |

### 6.3 å…³é”®æ”¶ç›Š

1. **é™ä½ç»´æŠ¤æˆæœ¬**ï¼šæ–°å¢å­—æ®µæ— éœ€ä¿®æ”¹ä»£ç ï¼Œè‡ªåŠ¨ç”Ÿæˆå½•å…¥ç•Œé¢
2. **æå‡ç”¨æˆ·ä½“éªŒ**ï¼šæ•°æ®åŒå‘å®æ—¶åŒæ­¥ï¼Œæ“ä½œæµç•…
3. **å¢å¼ºæ‰©å±•æ€§**ï¼šæ”¯æŒå¤šæ¨¡æ¿ã€åŠ¨æ€å­—æ®µã€å¤æ‚éªŒè¯
4. **æé«˜æ•°æ®ä¸€è‡´æ€§**ï¼šæ¶ˆé™¤æ•°æ®æ–­ç‚¹ï¼Œä¿è¯å®Œæ•´æ€§
5. **é™ä½å¼€å‘é£é™©**ï¼šç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯

### 6.4 é£é™©è¯„ä¼°

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| é‡æ„å¼•å…¥æ–°Bug | ä¸­ | é«˜ | å®Œå–„å•å…ƒæµ‹è¯•ï¼Œé€æ­¥è¿ç§» |
| æ€§èƒ½ä¸‹é™ | ä½ | ä¸­ | è™šæ‹ŸåŒ–æ¸²æŸ“ï¼Œé˜²æŠ–æœºåˆ¶ |
| å…¼å®¹æ€§ç ´å | ä½ | é«˜ | ä¿ç•™æ—§APIï¼Œæ¸è¿›å¼è¿ç§» |
| å­¦ä¹ æ›²çº¿é™¡å³­ | ä¸­ | ä½ | è¯¦ç»†æ–‡æ¡£ï¼Œä»£ç æ³¨é‡Š |

### 6.5 å»ºè®®ä¼˜å…ˆçº§

**ç«‹å³æ‰§è¡Œï¼ˆæœ¬å‘¨å†…ï¼‰**ï¼š
- âœ… é˜¶æ®µä¸€ï¼šå…ƒæ•°æ®é©±åŠ¨ï¼ˆ24å°æ—¶ï¼‰
- âœ… é˜¶æ®µäºŒï¼šåŒå‘åŒæ­¥ï¼ˆ19å°æ—¶ï¼‰

**è¿‘æœŸæ‰§è¡Œï¼ˆæœ¬æœˆå†…ï¼‰**ï¼š
- âš ï¸ é˜¶æ®µå››ï¼šè¡¨æ ¼æ•°æ®æµä¿®å¤ï¼ˆ24å°æ—¶ï¼‰
- âš ï¸ é˜¶æ®µä¸‰ï¼šPDFåˆ·æ–°æ”¹è¿›ï¼ˆ8å°æ—¶ï¼‰

**é•¿æœŸè§„åˆ’ï¼ˆä¸‹å­£åº¦ï¼‰**ï¼š
- ğŸ“‹ é˜¶æ®µäº”ï¼šé«˜çº§ç‰¹æ€§ï¼ˆ28å°æ—¶ï¼‰

---

## é™„å½•ï¼šä»£ç å¯¹æ¯”ç¤ºä¾‹

### é™„å½•Aï¼šæ”¹è¿›å‰ vs æ”¹è¿›å

#### åœºæ™¯ï¼šæ–°å¢ä¸€ä¸ª"æ‰‹æœºå·"å­—æ®µ

**æ”¹è¿›å‰**ï¼ˆéœ€è¦ä¿®æ”¹3å¤„ï¼‰ï¼š

```csharp
// 1. DataEntryViewModel.cs
[ObservableProperty]
private string _phoneNumber;

partial void OnPhoneNumberChanged(string value)
{
    _sharedDataService.UpdateUserData("PhoneNumber", value); // ç¡¬ç¼–ç 
}

// 2. æ¨¡æ¿æ–‡ä»¶ï¼ˆåˆ›å»ºæ–°ControlElementï¼‰
{
    "ElementId": "phone",  // éœ€è¦æ‰‹åŠ¨ä¸ä¸Šé¢çš„"PhoneNumber"å¯¹åº”
    "Type": "TextBox",
    "DisplayName": "æ‰‹æœºå·",
    "X": 50,
    "Y": 150,
    ...
}

// 3. TemplateEditorViewModel.cs
private void HandleDataChange(string key, object value)
{
    // éœ€è¦æ·»åŠ æ–°çš„case
    switch (key)
    {
        case "PhoneNumber":  // ç¡¬ç¼–ç 
            // ...
            break;
        // ...
    }
}
```

**æ”¹è¿›å**ï¼ˆåªéœ€ä¿®æ”¹1å¤„ï¼‰ï¼š

```csharp
// åªéœ€åœ¨æ¨¡æ¿ä¸­æ·»åŠ ControlElementï¼Œå…¶ä»–å…¨éƒ¨è‡ªåŠ¨ç”Ÿæˆ
{
    "ElementId": "phone",  // è‡ªåŠ¨æ˜ å°„ä¸ºFieldKey
    "Type": "TextBox",
    "DisplayName": "æ‰‹æœºå·",
    "IsRequired": true,
    "ValidationRegex": "^1[3-9]\\d{9}$",  // æ‰‹æœºå·éªŒè¯
    "X": 50,
    "Y": 150,
    ...
}
```

å½•å…¥ç•Œé¢ã€ç»‘å®šé€»è¾‘ã€éªŒè¯è§„åˆ™ã€åŒæ­¥æœºåˆ¶å…¨éƒ¨è‡ªåŠ¨ç”Ÿæˆï¼

### é™„å½•Bï¼šæ•°æ®æµå®Œæ•´åº¦å¯¹æ¯”

**æ”¹è¿›å‰**ï¼š
```
DataEntry â”€â”€â†’ SharedDataService â”€â”€â†’ TemplateEditor â”€â”€âœ—â†’ DataEntry
                                      â†“
                                   PdfPreview
```

**æ”¹è¿›å**ï¼š
```
DataEntry â†â”€â†’ SharedDataService â†â”€â†’ TemplateEditor
     â†“                    â†“                  â†“
  éªŒè¯å±‚              åŒæ­¥åè°ƒå™¨            æ’¤é”€é‡åš
     â†“                    â†“                  â†“
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ PdfPreview â†â”€â”€â”€â”€â”€â”€â”˜
```

---

**æ–‡æ¡£ç»“æŸ**

å¦‚æœ‰ç–‘é—®æˆ–éœ€è¦è¿›ä¸€æ­¥è®¨è®ºï¼Œè¯·è”ç³»æ¶æ„å›¢é˜Ÿã€‚
